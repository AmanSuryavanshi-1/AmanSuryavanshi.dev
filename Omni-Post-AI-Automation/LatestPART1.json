{
    "nodes": [
        {
            "parameters": {},
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                2224,
                1568
            ],
            "id": "2861539f-adc5-4bdc-bebf-1b24e5e85f8b",
            "name": "When clicking 'Execute workflow'"
        },
        {
            "parameters": {
                "resource": "databasePage",
                "operation": "getAll",
                "databaseId": {
                    "__rl": true,
                    "value": "21a34bf1-f7e5-8035-b16f-d5ebf63a86a9",
                    "mode": "list"
                },
                "returnAll": true,
                "filterType": "manual",
                "filters": {
                    "conditions": [
                        {
                            "key": "Status|select",
                            "condition": "equals",
                            "selectValue": "Ready to Generate"
                        }
                    ]
                },
                "options": {
                    "sort": {
                        "sortValue": [
                            {
                                "key": "ManualOrder|number",
                                "direction": "ascending"
                            },
                            {
                                "key": "Priority|select",
                                "direction": "ascending"
                            },
                            {
                                "timestamp": true,
                                "key": "created_time",
                                "direction": "ascending"
                            }
                        ]
                    }
                }
            },
            "id": "ed6b330b-0f1c-47e9-ae85-f0770c55589a",
            "name": "Notion â€“ Get Ready Content",
            "type": "n8n-nodes-base.notion",
            "typeVersion": 2,
            "position": [
                2448,
                1568
            ],
            "credentials": {
                "notionApi": {
                    "id": "je8hKPK6RzYSk4JA",
                    "name": "Notion account 2"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 1
                    },
                    "conditions": [
                        {
                            "leftValue": "={{ $input.all().length > 0 }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "equals"
                            },
                            "id": "6855ced2-6ef0-4ea1-acd1-a9326c4b67f9"
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "3cc6df01-e967-4b45-af45-36435b800979",
            "name": "Filter â€“ Has Content",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                2672,
                1568
            ]
        },
        {
            "parameters": {
                "jsCode": "// CONTENT SELECTION & PROFILE SETUP\nconst items = $input.all();\n\nif (!items || items.length === 0) {\nÂ  console.log('âŒ No content ready for processing');\nÂ  return [];\n}\n\n// Get first item (priority + FIFO)\nconst item = items[0].json;\nconsole.log('ğŸ¯ Processing item:', item.id);\n\n// Enhanced property extraction with fallbacks\nconst getProperty = (obj, path, defaultValue = '') => {\nÂ  const keys = path.split('.');\nÂ  let result = obj;\nÂ  for (const key of keys) {\nÂ  Â  if (result && typeof result === 'object' && key in result) {\nÂ  Â  Â  result = result[key];\nÂ  Â  } else {\nÂ  Â  Â  return defaultValue;\nÂ  Â  }\nÂ  }\nÂ  return result || defaultValue;\n};\n\nconst title = getProperty(item, 'properties.Content Pages.title.0.plain_text') || \nÂ  Â  Â  Â  Â  Â  Â  getProperty(item, 'properties.title.title.0.plain_text') ||\nÂ  Â  Â  Â  Â  Â  Â  getProperty(item, 'properties.Name.title.0.plain_text') ||\nÂ  Â  Â  Â  Â  Â  Â  getProperty(item, 'name') || \nÂ  Â  Â  Â  Â  Â  Â  'Untitled Content';\n\nconst category = getProperty(item, 'properties.Category.select.name') || \nÂ  Â  Â  Â  Â  Â  Â  Â  Â 'Learning';\n\nconst priority = getProperty(item, 'properties.Priority.select.name') || \nÂ  Â  Â  Â  Â  Â  Â  Â  Â 'normal';\n\n// Complete user profile for authentic content\nconst userProfile = {\nÂ  name: 'Aman Surya',\nÂ  role: 'Fresh CS Graduate & AI/ML Enthusiast',\nÂ  focus: 'Building with Next.js/React/n8n, seeking AI PM roles',\nÂ  personality: 'Authentic, curious, growth-minded, detail-oriented',\nÂ  expertise: ['JavaScript', 'React', 'Next.js', 'n8n', 'AI/ML', 'Automation', 'Product Management'],\nÂ  audience: 'Tech community, AI enthusiasts, developers, PM aspirants',\nÂ  timezone: 'Asia/Kolkata',\nÂ  writing_style: {\nÂ  Â  twitter: 'Casual, engaging, thread-friendly, question-driven, community-focused',\nÂ  Â  linkedin: 'Professional, detailed, story-driven, insight-rich, career-focused'\nÂ  },\nÂ  content_goals: {\nÂ  Â  primary: 'Build technical credibility for AI PM roles',\nÂ  Â  secondary: 'Help fellow developers learn and grow',\nÂ  Â  engagement: 'Create genuine discussions and valuable connections'\nÂ  }\n};\n\nconst sessionId = `session_${Date.now()}_${(item.id || '').toString().substring(0, 8)}`;\n\nreturn [{\nÂ  json: {\nÂ  Â  id: item.id,\nÂ  Â  title: title,\nÂ  Â  category: category,\nÂ  Â  priority: priority,\nÂ  Â  sessionId: sessionId,\nÂ  Â  userProfile: userProfile,\nÂ  Â  processingStartTime: new Date().toISOString(),\nÂ  Â  remainingItems: items.length - 1,\nÂ  Â  originalId: item.id\nÂ  }\n}];"
            },
            "id": "1d7a915b-a92b-48f2-8152-f9fc7245d0b0",
            "name": "Code â€“ Select Content & Profile",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2896,
                1568
            ]
        },
        {
            "parameters": {
                "resource": "databasePage",
                "operation": "update",
                "pageId": {
                    "__rl": true,
                    "value": "={{ $('Code â€“ Select Content & Profile').item.json.id }}",
                    "mode": "id"
                },
                "propertiesUi": {
                    "propertyValues": [
                        {
                            "key": "Status|select",
                            "type": "select",
                            "selectValue": "Generating"
                        },
                        {
                            "key": "SessionID|rich_text",
                            "richText": true,
                            "text": {
                                "text": [
                                    {
                                        "text": "={{ $('Code â€“ Select Content & Profile').item.json.sessionId }}",
                                        "annotationUi": {}
                                    }
                                ]
                            }
                        },
                        {
                            "key": "Processing Started|date",
                            "type": "date",
                            "date": "={{ $('Code â€“ Select Content & Profile').item.json.processingStartTime }}"
                        },
                        {
                            "key": "Notes|rich_text",
                            "richText": true,
                            "text": {
                                "text": [
                                    {
                                        "text": "=ğŸ”„ Processing started\\nSession: {{ $('Code â€“ Select Content & Profile').item.json.sessionId }}\\nPriority: {{ $('Code â€“ Select Content & Profile').item.json.priority }}\\nCategory: {{ $('Code â€“ Select Content & Profile').item.json.category }}\\nStarted: {{ new Date().toLocaleString('en-IN', {timeZone: 'Asia/Kolkata'}) }} IST",
                                        "annotationUi": {}
                                    }
                                ]
                            }
                        }
                    ]
                },
                "options": {}
            },
            "id": "8b6d0899-2a32-42fc-a907-bd0d4f4451ec",
            "name": "Notion â€“ Update to Processing",
            "type": "n8n-nodes-base.notion",
            "typeVersion": 2,
            "position": [
                3344,
                1568
            ],
            "credentials": {
                "notionApi": {
                    "id": "je8hKPK6RzYSk4JA",
                    "name": "Notion account 2"
                }
            }
        },
        {
            "parameters": {
                "resource": "block",
                "operation": "getAll",
                "blockId": {
                    "__rl": true,
                    "value": "={{ $json.id }}",
                    "mode": "id"
                },
                "returnAll": true,
                "fetchNestedBlocks": true,
                "simplifyOutput": false
            },
            "id": "95be0445-66ea-4f7a-ab90-c7a0d2705929",
            "name": "Notion â€“ Extract All Blocks",
            "type": "n8n-nodes-base.notion",
            "typeVersion": 2.2,
            "position": [
                3568,
                1568
            ],
            "credentials": {
                "notionApi": {
                    "id": "je8hKPK6RzYSk4JA",
                    "name": "Notion account 2"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// PRODUCTION-READY NOTION CONTENT EXTRACTION (V2 - FIXED OUTPUT)\n\ntry {\n  console.log('ğŸ” Starting comprehensive content extraction...');\n  \n  const extractItems = $items('Notion â€“ Extract All Blocks');\n  if (!extractItems?.length) {\n    throw new Error('No blocks from Notion â€“ Extract All Blocks');\n  }\n  console.log(`ğŸ“¥ Processing ${extractItems.length} block items`);\n  \n  const allBlocks = extractItems.map(item => item.json);\n  const blockMap = new Map();\n  const topLevelBlocks = [];\n  \n  // Build hierarchical tree\n  allBlocks.forEach(block => {\n    blockMap.set(block.id, { ...block, children: [] });\n  });\n  \n  allBlocks.forEach(block => {\n    if (block.parent?.type === 'page_id') {\n      topLevelBlocks.push(blockMap.get(block.id));\n    } else if (block.parent?.type === 'block_id') {\n      const parent = blockMap.get(block.parent.block_id);\n      if (parent) {\n        parent.children.push(blockMap.get(block.id));\n      }\n    }\n  });\n  \n  console.log(`ğŸŒ³ Built tree with ${topLevelBlocks.length} top-level blocks`);\n  \n  // Text extraction helper\n  const extractText = (richTextArray) => {\n    if (!Array.isArray(richTextArray)) return '';\n    return richTextArray\n      .map(item => item.plain_text || item.text?.content || '')\n      .join('')\n      .trim();\n  };\n  \n  // Image processing helper\n  const processImage = (url, caption = '') => {\n    if (!url) return null;\n    try {\n      return {\n        url: url,\n        caption: caption,\n        alt_text: caption || 'Content image',\n        processing_needed: true\n      };\n    } catch {\n      return null;\n    }\n  };\n  \n  // Recursive block renderer\n  function renderBlock(block, level = 0) {\n    if (!block?.type) return { text: '', sections: [], images: [] };\n    \n    const indent = '  '.repeat(level);\n    const blockData = block[block.type] || {};\n    let content = '';\n    let sections = [];\n    let images = [];\n    let text = extractText(blockData?.rich_text || blockData?.text || []);\n    \n    switch (block.type) {\n      case 'heading_1':\n        content = `\\\\n# ${text}\\\\n\\\\n`;\n        if (text) sections.push({ level: 1, title: text, content: '', id: block.id });\n        break;\n      case 'heading_2':\n        content = `\\\\n## ${text}\\\\n\\\\n`;\n        if (text) sections.push({ level: 2, title: text, content: '', id: block.id });\n        break;\n      case 'heading_3':\n        content = `\\\\n### ${text}\\\\n\\\\n`;\n        if (text) sections.push({ level: 3, title: text, content: '', id: block.id });\n        break;\n      case 'paragraph':\n        if (text) content = `${text}\\\\n\\\\n`;\n        break;\n      case 'bulleted_list_item':\n        if (text) content = `${indent}- ${text}\\\\n`;\n        break;\n      case 'numbered_list_item':\n        if (text) content = `${indent}1. ${text}\\\\n`;\n        break;\n      case 'toggle':\n        if (text) {\n          content = `\\\\nâ–¶ï¸ ${text}\\\\n`;\n          sections.push({ level: 4, title: text, content: '', id: block.id, type: 'toggle' });\n        }\n        break;\n      case 'callout':\n        const icon = blockData?.icon?.emoji || 'ğŸ’¡';\n        if (text) content = `\\\\n${icon} **${text}**\\\\n\\\\n`;\n        break;\n      case 'quote':\n        if (text) content = `\\\\n> ${text}\\\\n\\\\n`;\n        break;\n      case 'code':\n        const language = blockData?.language || 'text';\n        if (text) {\n          content = `\\\\n\\`\\`\\`${language}\\\\n${text}\\\\n\\`\\`\\`\\\\n\\\\n`;\n          sections.push({ level: 5, title: `Code: ${language}`, content: text, id: block.id, type: 'code' });\n        }\n        break;\n      case 'divider':\n        content = '\\\\n---\\\\n\\\\n';\n        break;\n      case 'image':\n        const imageUrl = blockData?.file?.url || blockData?.external?.url;\n        if (imageUrl) {\n          const processedImage = processImage(imageUrl, text);\n          if (processedImage) {\n            images.push(processedImage);\n            content = `\\\\n[ğŸ“¸ Image: ${text || 'Visual content'}]\\\\n\\\\n`;\n          }\n        }\n        break;\n      case 'video':\n        content = `\\\\n[ğŸ¥ Video: ${text || 'Video content'}]\\\\n\\\\n`;\n        break;\n      case 'bookmark':\n        const bookmarkUrl = blockData?.url || '';\n        if (bookmarkUrl) content = `\\\\n[ğŸ”— ${text || bookmarkUrl}](${bookmarkUrl})\\\\n\\\\n`;\n        break;\n      default:\n        if (text) content = `${indent}${text}\\\\n\\\\n`;\n        break;\n    }\n    \n    // Process children recursively\n    if (block.children?.length) {\n      const childrenResult = block.children\n        .map(child => renderBlock(child, level + 1))\n        .reduce((acc, result) => {\n          acc.text += result.text;\n          acc.sections = acc.sections.concat(result.sections);\n          acc.images = acc.images.concat(result.images);\n          return acc;\n        }, { text: '', sections: [], images: [] });\n      \n      content += childrenResult.text;\n      sections = sections.concat(childrenResult.sections);\n      images = images.concat(childrenResult.images);\n    }\n    \n    return { text: content, sections: sections, images: images };\n  }\n  \n  // Process all blocks\n  const result = topLevelBlocks\n    .map(block => renderBlock(block))\n    .reduce((acc, blockResult) => {\n      acc.text += blockResult.text;\n      acc.sections = acc.sections.concat(blockResult.sections);\n      acc.images = acc.images.concat(blockResult.images);\n      return acc;\n    }, { text: '', sections: [], images: [] });\n  \n  // Clean up text\n  let fullText = result.text\n    .replace(/\\n{3,}/g, '\\n\\n')\n    .replace(/\\s+$/gm, '')\n    .trim();\n  \n  const stats = {\n    totalBlocks: allBlocks.length,\n    processedBlocks: topLevelBlocks.length,\n    characterCount: fullText.length,\n    wordCount: fullText.split(/\\s+/).filter(w => w.length > 0).length,\n    sections: result.sections.length,\n    images: result.images.length,\n    toggleSections: result.sections.filter(s => s.type === 'toggle').length,\n    codeSections: result.sections.filter(s => s.type === 'code').length\n  };\n  \n  console.log('âœ… Content extraction complete:', stats);\n  \n  // â­ KEY FIX: Wrap everything in 'sourceContent'\n  return [{\n    json: {\n      sourceContent: {\n        name: $('Notion â€“ Update to Processing').first().json.name,\n        categories: $('Notion â€“ Update to Processing').first().json.property_category,\n        fullText: fullText,\n        sections: result.sections,\n        images: result.images,\n        extractionStats: stats,\n        contentMetadata: {\n          totalSections: result.sections.length,\n          hasImages: result.images.length > 0,\n          hasCode: result.sections.some(s => s.type === 'code'),\n          hasToggles: result.sections.some(s => s.type === 'toggle'),\n          hasLists: fullText.includes('- ') || /^\\d+\\.\\s/m.test(fullText),\n          complexity: stats.wordCount > 800 ? 'high' : stats.wordCount > 400 ? 'medium' : 'low'\n        }\n      }\n    }\n  }];\n  \n} catch (error) {\n  console.error('âŒ Content extraction failed:', error.message);\n  return [{\n    json: {\n      sourceContent: {\n        fullText: `Content extraction error: ${error.message}`,\n        sections: [],\n        images: [],\n        extractionStats: { error: true },\n        contentMetadata: { error: error.message }\n      }\n    }\n  }];\n}\n"
            },
            "id": "2ab0ce09-8fa0-4d35-b3d4-a9dd89f46b7e",
            "name": "Code â€“ Extract & Process Content",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3792,
                1568
            ]
        },
        {
            "parameters": {
                "numberInputs": 4
            },
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3.2,
            "position": [
                6032,
                1440
            ],
            "id": "0d8c825d-9f02-42e6-b32c-b824a0474fcd",
            "name": "Merge2"
        },
        {
            "parameters": {
                "jsCode": "const items = $input.all();\n// Extract IDs, handling skipped platforms\nconst getIdOrNull = (item) => {\n  if (!item?.json) return null;\n  if (item.json.skipped) return null;\n  return item.json.id || null;\n};\nconst twitterId = getIdOrNull(items[0]);\nconst linkedinId = getIdOrNull(items[1]);\nconst blogId = getIdOrNull(items[2]);\nconst imageId = getIdOrNull(items[3]);\n// Log what was generated\nconsole.log('âœ“ Twitter ID:', twitterId || 'SKIPPED');\nconsole.log('âœ“ LinkedIn ID:', linkedinId || 'SKIPPED');\nconsole.log('âœ“ Blog ID:', blogId || 'SKIPPED');\n// Only throw error if ALL platforms were skipped\nif (!twitterId && !linkedinId && !blogId) {\n  throw new Error('No platforms selected! At least one platform must be selected in Notion.');\n}\nreturn [{\n  json: {\n    Twitter_id: twitterId,\n    LinkedIn_id: linkedinId,\n    Blog_id: blogId,\n    Image_Tasklist_id: imageId,\n    // Pass through which platforms were selected\n    platformsSelected: {\n      twitter: !!twitterId,\n      linkedin: !!linkedinId,\n      blog: !!blogId\n    }\n  }\n}];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                6256,
                1472
            ],
            "id": "bbd0037f-2a33-4043-851a-7d0480221076",
            "name": "ID Structuring"
        },
        {
            "parameters": {
                "jsCode": "// Personal Brand Context - The Foundation\n// Handles: Toggle headings, nested sections, code blocks, variable lengths\nconst personalContext = {\n  // CORE IDENTITY\n  name: \"Aman Suryavanshi\",\n  primary_focus: \"AI Automation Developer | Full Stack Automation Developer\",\n  experience_type: \"Fresh CS Graduate | Project-based only (No Professional Experience)\",\n  \n  // LOCATION & AVAILABILITY (Corrected field, avoid duplicate)\n  location: \"Delhi/NCR + Remote (India & Global)\",\n  availability: \"Open to full-time, contract, freelance\",\n  \n  // TARGET POSITIONS (Primary focus for content positioning)\n  targetRoles: [\n    \"No-Code/Low-Code Developer\",\n    \"Automation Developer\", \n    \"Automation Specialist\",\n    \"Technical Product Coordinator\",\n    \"AI Developer\",\n    \"Automation Architect\",\n    \"Systems & Process Automation Engineer\",\n    \"AI Product Manager (after 1-2 years experience)\"\n  ],\n  \n  // TECH STACK (What makes you HIREABLE)\n  skills: {\n    frontend: [\"Next.js 14\", \"React.js\", \"TypeScript\", \"Tailwind CSS\"],\n    automation: [\"n8n Workflow Orchestration\", \"Cloudflare Tunnel\", \"AI Agent Dev\"],\n    aiml: [\"Python\", \"LLMs (Gemini, Claude, GPT)\", \"RAG\", \"LangChain\"],\n    integration: [\"RESTful APIs\", \"Webhooks\", \"Firebase\", \"Supabase\"],\n    systems: [\"Performance Optimization\", \"Modular Architecture\", \"Technical Docs\"]\n  },\n\n  // LIVE PROJECTS (Include in content when relevant)\n  projects: {\n    workflow_repo: {\n      name: \"N8N Workflows Repository\",\n      url: \"https://github.com/AmanSuryavanshi-1/N8N/tree/main/workflows\",\n      description: \"Centralized n8n workflow logic\"\n    },\n    aviators: {\n      name: \"Aviators Training Centre\",\n      url: \"https://github.com/AmanSuryavanshi-1/AviatorsTrainingCentre\",\n      tech: [\"Next.js\", \"Firebase\", \"n8n\"],\n      achievement: \"95+ Lighthouse score, 80% reduction in manual tasks, 3L+ revenue\"\n    },\n    build_in_public: {\n      name: \"Build-in-Public Automation\",\n      status: \"Ongoing\",\n      tech: [\"n8n\", \"AI/LLMs\", \"Notion API\", \"X/LinkedIn APIs\"],\n      goal: \"Multi-platform content distribution automation\"\n    },\n    efficiency_agent: {\n      name: \"Personal Efficiency Agent\",\n      status: \"Ongoing\",\n      tech: [\"n8n AI Agents\", \"Notion API\", \"Postgres Memory\"],\n      goal: \"AI task management & daily tracking\"\n    }\n  },\n\n  // SERVICES YOU OFFER (For client attraction)\n  services: [\n    \"NextJS website development (Lighthouse & SEO optimized)\",\n    \"Front-end Web Development\",\n    \"n8n workflow automation for businesses + Next JS frontend\",\n    \"API integration & backend systems\",\n    \"No-code/low-code developement/consulting\"\n  ],\n\n  // SOCIAL PROOF LINKS\n  socials: {\n    github: \"https://github.com/AmanSuryavanshi-1\",\n    linkedin: \"https://www.linkedin.com/in/aman-suryavanshi-6b0aba347/\",\n    twitter: \"https://x.com/_AmanSurya\",\n    portfolio: \"https://amansuryavanshi-dev.vercel.app/\"\n  },\n\n  // CONTENT VOICE (How you sound)\n  voiceAttributes: [\n    \"Authentic & transparent (share real struggles + wins)\",\n    \"Detail-oriented with technical depth\",\n    \"Growth-minded (always learning)\",\n    \"Practical over theoretical\",\n    \"Builds in public\",\n    \"Helpful & community-focused\"\n  ],\n\n  // HIDDEN OBJECTIVES (guides content strategy but never stated explicitly)\n  hiddenGoals: {\n    primary: \"Get inbound job offers without applying\",\n    secondary: \"Attract freelance/contract clients organically\",\n    tertiary: \"Build reputation as automation expert\",\n    longTerm: \"Become go-to person for no-code/automation in network\"\n  }\n};\n\n// Main n8n code node logic\nconst incomingItems = $input.all();\n\n\n// INTELLIGENT CONTENT SUMMARIZATION (Cost-Optimized)\n// Limits to 2000 chars while preserving structure\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction intelligentSummarize(sourceContent) {\n  if (!sourceContent) return { summary: \"No content available\", structure: \"empty\", wordCount: 0,complexity: \"unknown\" };\n\n  // Extract key structural elements\n  const { fullText, sections, extractionStats } = sourceContent;\n\n  let summary = \"\";\n  // Priority 1: Section headings (highest signal-to-noise ratio)\n  const sectionTitles = (sections || [])\n    .filter(s => s.title && s.title.length > 3) // Skip very short titles\n    .map(s => `â€¢ ${s.title}`)\n    .slice(0, 12) // Max 12 headings\n    .join('\\n');\n  \n  if (sectionTitles) {\n    summary += \"**Key Sections:**\\n\" + sectionTitles + \"\\n\\n\";\n  }\n  \n  // Priority 2: First substantive section content (provides context)\n  if (sections && sections.length > 0) {\n    // Find first section with actual content (not just heading)\n    const contentSection = sections.find(s => \n      s.content && s.content.length > 50\n    );\n    \n    if (contentSection) {\n      summary += \"**Core Content Sample:**\\n\" \n        + contentSection.content.substring(0, 500)\n        .replace(/\\n+/g, ' ') // Remove line breaks for compactness\n        + \"...\\n\";\n    }\n  }\n  \n  // Priority 3: Fallback to fullText if sections are empty\n  if (!sections || sections.length === 0) {\n    summary = \"**Content Preview:**\\n\" + (fullText || \"\").substring(0, 1800) + \"...\";\n  }\n  \n  // Enforce strict 2000 char limit (API cost control)\n  summary = summary.substring(0, 2000);\n  \n  return {\n    summary,\n    structure: extractionStats?.hasToggles ? \"hierarchical\" : \"linear\",\n    wordCount: extractionStats?.wordCount || 0,\n    complexity: extractionStats?.complexity || \"unknown\",\n    sectionCount: sections?.length || 0,\n    hasCode: extractionStats?.codeSections > 0,\n    hasToggles: extractionStats?.toggleSections > 0\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// PROCESS AND MERGE\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nreturn incomingItems.map(item => {\n  const sourceContent = item.json.sourceContent || {};\n  const contentSummary = intelligentSummarize(sourceContent);\n  \n  return {\n    json: {\n      // Preserve all original data from previous nodes\n      ...item.json,\n      // Added personal context\n      personalContext,\n      // Add optimized content summary for AI prompts\n      contentSummary, // This is what AI nodes will use\n      // Keep full sourceContent for reference if needed\n      _fullSourceContent: sourceContent\n    }\n  };\n});\n\n// INTELLIGENT NOTION CONTENT SUMMARIZATION (Cost-Optimized)\n// Limits to 2000 chars while preserving structure\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction intelligentSummarize(sourceContent) {\n  if (!sourceContent) return { summary: \"\", structure: \"empty\" };\n  \n  // Extract key structural elements\n  const { fullText, sections, extractionStats } = sourceContent;\n  \n  // Priority 1: Section headings (most informative)\n  let summary = \"\";\n  const sectionTitles = (sections || [])\n    .filter(s => s.title && s.title.length > 0)\n    .map(s => `â€¢ ${s.title}`)\n    .slice(0, 10) // Max 10 headings\n    .join('\\n');\n  \n  if (sectionTitles) {\n    summary += \"**Key Sections:**\\n\" + sectionTitles + \"\\n\\n\";\n  }\n  \n  // Priority 2: First substantive content (context)\n  if (sections && sections.length > 0) {\n    const firstContentSection = sections.find(s => s.content && s.content.length > 100);\n    if (firstContentSection) {\n      summary += \"**Core Content:**\\n\" + firstContentSection.content.substring(0, 600) + \"...\\n\";\n    }\n  }\n  \n  // Priority 3: Full text truncation if sections unavailable\n  if (!sections || sections.length === 0) {\n    summary = \"**Content Preview:**\\n\" + (fullText || \"\").substring(0, 1500) + \"...\";\n  }\n  \n  // Enforce 2000 char limit\n  summary = summary.substring(0, 2000);\n  \n  return {\n    summary,\n    structure: extractionStats?.hasToggles ? \"hierarchical\" : \"linear\",\n    wordCount: extractionStats?.wordCount || 0,\n    complexity: extractionStats?.complexity || \"unknown\"\n  };\n}\n\n// PROCESS AND MERGE\nreturn incomingItems.map(item => {\n  const sourceContent = item.json.sourceContent || {};\n  const contentSummary = intelligentSummarize(sourceContent);\n  \n  return {\n    json: {\n      ...item.json,\n      personalContext,\n      contentSummary, // This is what AI nodes will use\n      // Keep full sourceContent for reference\n      _fullSourceContent: sourceContent\n    }\n  };\n});\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                4016,
                1568
            ],
            "id": "e7fe9697-d8f8-4a6b-837a-6decefc0faf0",
            "name": "Code â€“ Personal Context Builder"
        },
        {
            "parameters": {
                "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CONTEXT MERGER (fetches from previous node, merges with Perplexity)\n// Place after Perplexity node, queries previous (Personal Context Builder) node\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('ğŸ”— Starting final context merger...');\n\n// 1. Fetch JSON data from the previous Personal Context Builder node\n// const previous = $('Code â€“ Personal Context Builder').first().json || {};\nconst previous = $('Code â€“ Personal Context Builder').first().json;\n\n// 2. Get Perplexity output directly â€“ comes as $json in this node\n// const perplexity = $json || {};\nconst perplexity = $json;\n\n// 3. Merge key blocks: always prefer Perplexity for \"research\", but get everything else from previous\n// const personalContext = previous.personalContext || {};\nconst personalContext = previous.personalContext;\nconst sourceContent = previous.sourceContent || {};\nconst contentSummary = previous.contentSummary || {};\nconst perplexityChoices = perplexity.choices;\n\n// Use fallback/default for every key field!\nconst name = personalContext.name || 'Unknown User';\nconst title = sourceContent.name || 'Untitled Content';\nconst categories = Array.isArray(sourceContent.categories) ? sourceContent.categories : ['General'];\nconst primaryCategory = categories[0] || 'General';\nconst summary = contentSummary.summary || '';\nconst wordCount = contentSummary.wordCount || 0;\nconst structure = contentSummary.structure || 'linear';\nconst complexity = contentSummary.complexity || 'unknown';\nconst fullText = sourceContent.fullText || '';\n\n// Perplexity research blockâ€”parse its result\nlet research = {};\ntry {\n  if (\n    Array.isArray(perplexityChoices) &&\n    perplexityChoices.length > 0 &&\n    typeof perplexityChoices[0] === 'object'\n  ) {\n    let rawContent = perplexityChoices[0].message?.content ?? '';\n    rawContent = rawContent.replace(/``````/g, '').trim();\n    if (rawContent) {\n      research = JSON.parse(rawContent);\n      console.log('âœ… Parsed Perplexity JSON.');\n    } else {\n      throw new Error('Empty content in Perplexity choices.');\n    }\n  } else {\n    throw new Error('Perplexity choices incomplete.');\n  }\n} catch (err) {\n  console.warn(`âš ï¸ Perplexity parsing failed: ${err.message}. Using fallback research.`);\n  research = {\n    authenticHashtags: {\n      twitter: ['#BuildInPublic', `#${primaryCategory}`, '#Automation', '#NoCode', '#n8n'],\n      linkedin: ['#ProcessAutomation', `#${primaryCategory}`, '#SystemsThinking', '#AI'],\n    },\n    optimalTimesIST: {\n      twitter_primary_ist: \"9:00-11:00 am IST\",\n      twitter_secondary_ist: \"8:30-9:30 pm IST (US/EU overlap)\",\n      linkedin_ist: \"10:00-12:00 am IST (Tue-Thu)\"\n    },\n    authenticHooks: {\n      twitter_example: \"Solving a weird API quirk in n8n todayâ€”here's the step that finally worked. Anyone else get stuck on webhook reliability?\",\n      linkedin_example: \"Client automated 50% manual onboarding steps using n8n, saving 10 hours/week. Why did we choose modular flows?\"\n    },\n    developerPainPoints: [\n      \"Lack of reliable content scheduling tools for Indian time zones\",\n      \"Complicated OAuth flows between LinkedIn, X and custom APIs\"\n    ]\n  };\n}\n\n// Optional IDs/session info\nconst originalId = previous.originalId ?? null;\nconst sessionId = previous.sessionId ?? null;\nconst notionPageId = sourceContent.id ?? null;\nconst extractionStats = sourceContent.extractionStats ?? {};\nconst hasImages = Array.isArray(sourceContent.images) && sourceContent.images.length > 0;\nconst processingTime = new Date().toISOString();\n\n// Master context object (robust, merged)\nconst masterContext = {\n  personalContext: {\n    ...personalContext,\n    name\n  },\n  sourceContent: {\n    title,\n    categories,\n    primaryCategory,\n    summary,\n    wordCount,\n    structure,\n    complexity,\n    fullText\n  },\n  contentSummary: {\n    summary,\n    wordCount,\n    structure,\n    complexity\n  },\n  research,\n  originalId,\n  sessionId,\n  workflowMetadata: {\n    notionPageId,\n    extractionStats,\n    hasImages,\n    processingTime\n  }\n};\n\nconsole.log('âœ… Master context object created successfully!');\nreturn [{ json: masterContext }];\n"
            },
            "id": "bc4527a2-5049-44b8-bb65-330ac810b17e",
            "name": "Code â€“ CONTEXT MERGER",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                4464,
                1568
            ]
        },
        {
            "parameters": {
                "jsCode": "const input = $input.first().json;\nlet rawText = null;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// UNIVERSAL FORMAT HANDLER - Including GitHub Models\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// 1. OpenAI Chat Completions format (GitHub Models)\nif (input.choices?.[0]?.message?.content) {\n    rawText = input.choices[0].message.content;\n    console.log('âœ“ Extracted from OpenAI/GitHub Models format');\n}\n// 2. n8n-langchain OpenAI node (Groq) - Responses API format\nelse if (input.output?.[0]?.content?.[0]?.text) {\n    rawText = input.output[0].content[0].text;\n    console.log('âœ“ Extracted from Langchain OpenAI (Responses API)');\n}\n// 3. OpenRouter Community Node\nelse if (input.output && typeof input.output === 'string') {\n    rawText = input.output;\n    console.log('âœ“ Extracted from OpenRouter (output string)');\n}\n// 4. Gemini format\nelse if (input.content?.parts?.[0]?.text) {\n    rawText = input.content.parts[0].text;\n    console.log('âœ“ Extracted from Gemini format');\n}\n// 5. Direct message format\nelse if (input.message?.content) {\n    rawText = input.message.content;\n    console.log('âœ“ Extracted from direct message format');\n}\n// 6. Raw string\nelse if (typeof input === 'string') {\n    rawText = input;\n    console.log('âœ“ Extracted as raw string');\n}\n// 7. Fallback\nelse {\n    const keys = Object.keys(input).join(', ');\n    const sample = JSON.stringify(input).substring(0, 500);\n    throw new Error(`Cannot extract text. Keys: [${keys}]. Sample: ${sample}`);\n}\n\n// Clean and parse JSON\nlet cleaned = rawText\n    .replace(/^```json\\s*/i, '')\n    .replace(/^```\\s*/i, '')\n    .replace(/```\\s*$/g, '')\n    .trim();\n\n// JSON repair\ncleaned = cleaned.replace(/,\\s*}/g, '}');\ncleaned = cleaned.replace(/,\\s*]/g, ']');\n\nlet result;\ntry {\n    // Try to find JSON object\n    const firstBrace = cleaned.indexOf('{');\n    const lastBrace = cleaned.lastIndexOf('}');\n    if (firstBrace !== -1 && lastBrace !== -1) {\n        cleaned = cleaned.substring(firstBrace, lastBrace + 1);\n    }\n    result = JSON.parse(cleaned);\n    console.log('âœ“ JSON parsed');\n} catch (error) {\n    console.log('Raw text sample:', rawText.substring(0, 500));\n    throw new Error('Invalid JSON: ' + error.message);\n}\n\n// Flexible field extraction\nconst markdown = result.formatted_markdown || result.markdown || '';\nconst structured = result.structured_data || result.structured || result;\n\nif (!markdown && !structured.threads) {\n    console.log('Warning: Missing expected fields, using available data');\n}\n\nreturn {\n    json: {\n        markdown: markdown,\n        structured: structured,\n        platform: 'twitter'\n    }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5584,
                896
            ],
            "id": "cf99ce6e-514e-44e5-9ee7-c6e48f89833b",
            "name": "Process & Format Twitter Draft"
        },
        {
            "parameters": {
                "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BULLETPROOF LINKEDIN DRAFT PROCESSOR v3.0\n// Handles ANY LLM format: JSON, Markdown, or hybrid responses\n// Compatible with: OpenAI, Groq, Gemini, OpenRouter, GitHub Models, Claude, etc.\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $input.first().json;\nlet rawText = null;\n\nconsole.log('ğŸ” LinkedIn Draft Processor - Analyzing input format...');\nconsole.log('ğŸ“‹ Input keys:', Object.keys(input));\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// STEP 1: UNIVERSAL TEXT EXTRACTION - Handle all LLM response formats\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// 1. OpenAI/GitHub Models - Chat Completions format\nif (input.choices?.[0]?.message?.content) {\n    rawText = input.choices[0].message.content;\n    console.log('âœ“ Extracted from OpenAI/GitHub Models format');\n}\n// 2. Claude/Anthropic format\nelse if (input.content?.[0]?.text) {\n    rawText = input.content[0].text;\n    console.log('âœ“ Extracted from Claude/Anthropic format');\n}\n// 3. OpenRouter with \"response\" key (common community node format)\nelse if (input.response && typeof input.response === 'string') {\n    rawText = input.response;\n    console.log('âœ“ Extracted from OpenRouter (response string)');\n}\n// 4. n8n-langchain OpenAI node (Groq/others) - Responses API format\nelse if (input.output?.[0]?.content?.[0]?.text) {\n    rawText = input.output[0].content[0].text;\n    console.log('âœ“ Extracted from Langchain OpenAI (Responses API)');\n}\n// 5. OpenRouter with \"output\" key\nelse if (input.output && typeof input.output === 'string') {\n    rawText = input.output;\n    console.log('âœ“ Extracted from OpenRouter (output string)');\n}\n// 6. Gemini format (Google AI)\nelse if (input.content?.parts?.[0]?.text) {\n    rawText = input.content.parts[0].text;\n    console.log('âœ“ Extracted from Gemini format');\n}\n// 7. Gemini alternate format\nelse if (input.candidates?.[0]?.content?.parts?.[0]?.text) {\n    rawText = input.candidates[0].content.parts[0].text;\n    console.log('âœ“ Extracted from Gemini candidates format');\n}\n// 8. Direct message format (simple wrapper)\nelse if (input.message?.content) {\n    rawText = input.message.content;\n    console.log('âœ“ Extracted from direct message format');\n}\n// 9. Text field directly\nelse if (input.text && typeof input.text === 'string') {\n    rawText = input.text;\n    console.log('âœ“ Extracted from text field');\n}\n// 10. Result field (some custom nodes)\nelse if (input.result && typeof input.result === 'string') {\n    rawText = input.result;\n    console.log('âœ“ Extracted from result field');\n}\n// 11. Raw string input\nelse if (typeof input === 'string') {\n    rawText = input;\n    console.log('âœ“ Extracted as raw string');\n}\n// 12. Data field (some API responses)\nelse if (input.data && typeof input.data === 'string') {\n    rawText = input.data;\n    console.log('âœ“ Extracted from data field');\n}\n// 13. Generation field (some LLM wrappers)\nelse if (input.generation && typeof input.generation === 'string') {\n    rawText = input.generation;\n    console.log('âœ“ Extracted from generation field');\n}\n// 14. Fallback - try to find any string field with substantial content\nelse {\n    console.log('âš ï¸ Standard extraction failed, attempting deep search...');\n    for (const key of Object.keys(input)) {\n        const value = input[key];\n        if (typeof value === 'string' && value.length > 100) {\n            rawText = value;\n            console.log(`âœ“ Extracted from field: ${key}`);\n            break;\n        }\n    }\n}\n\n// Final fallback error\nif (!rawText || rawText.trim().length === 0) {\n    const keys = Object.keys(input).join(', ');\n    const sample = JSON.stringify(input).substring(0, 800);\n    throw new Error(`Cannot extract text content. Available keys: [${keys}]. Sample: ${sample}`);\n}\n\nconsole.log(`ğŸ“Š Raw text length: ${rawText.length} characters`);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// STEP 2: INTELLIGENT CONTENT TYPE DETECTION\n// Detect if response is JSON, Markdown, or hybrid\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst trimmedText = rawText.trim();\nconst startsWithMarkdown = /^#\\s|^\\*\\*|^-\\s|^>\\s|^[A-Z]/.test(trimmedText);\nconst hasJsonBlock = /```json[\\s\\S]*?```/i.test(trimmedText) || /^\\s*\\{/.test(trimmedText);\nconst looksLikeJson = trimmedText.startsWith('{') || trimmedText.startsWith('```json');\n\nconsole.log(`ğŸ” Content analysis - Markdown start: ${startsWithMarkdown}, Has JSON: ${hasJsonBlock}, Looks like JSON: ${looksLikeJson}`);\n\nlet markdown = '';\nlet structured = {};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// STEP 3: CONTENT PARSING STRATEGY\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// STRATEGY A: Pure Markdown or Markdown-first response\nif (startsWithMarkdown && !looksLikeJson) {\n    console.log('ğŸ“ Strategy A: Treating as pure markdown content');\n    \n    // Check if there's a JSON block embedded at the end\n    const jsonBlockMatch = trimmedText.match(/```json\\s*([\\s\\S]*?)\\s*```/i);\n    \n    if (jsonBlockMatch) {\n        // Extract markdown before the JSON block\n        const jsonBlockStart = trimmedText.indexOf('```json');\n        markdown = trimmedText.substring(0, jsonBlockStart).trim();\n        \n        // Try to parse the embedded JSON for structured data\n        try {\n            structured = JSON.parse(jsonBlockMatch[1].trim());\n            console.log('âœ“ Extracted embedded structured data from JSON block');\n        } catch (e) {\n            console.log('âš ï¸ Could not parse embedded JSON block, using empty structured data');\n            structured = {};\n        }\n    } else {\n        // Pure markdown, no JSON\n        markdown = trimmedText;\n        structured = {};\n    }\n}\n// STRATEGY B: JSON or JSON-first response\nelse {\n    console.log('ğŸ“ Strategy B: Attempting JSON extraction and repair');\n    \n    // Remove markdown code fences\n    let cleaned = rawText\n        .replace(/^```json\\s*/i, '')\n        .replace(/^```\\s*/i, '')\n        .replace(/```\\s*$/g, '')\n        .trim();\n    \n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // ADVANCED JSON REPAIR ENGINE\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    \n    // Find JSON boundaries\n    const firstBrace = cleaned.indexOf('{');\n    const lastBrace = cleaned.lastIndexOf('}');\n    \n    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {\n        // Store any markdown before the JSON\n        const preJsonMarkdown = cleaned.substring(0, firstBrace).trim();\n        cleaned = cleaned.substring(firstBrace, lastBrace + 1);\n        \n        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        // JSON Repair Operations\n        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        \n        // 1. Remove trailing commas before } or ]\n        cleaned = cleaned.replace(/,\\s*}/g, '}');\n        cleaned = cleaned.replace(/,\\s*]/g, ']');\n        \n        // 2. Fix unquoted property names\n        cleaned = cleaned.replace(/(\\{|,)\\s*([a-zA-Z_][a-zA-Z0-9_]*)\\s*:/g, '$1\"$2\":');\n        \n        // 3. Replace single quotes with double quotes for values\n        cleaned = cleaned.replace(/:\\s*'([^']*)'/g, ':\"$1\"');\n        cleaned = cleaned.replace(/\\[\\s*'([^']*)'/g, '[\"$1\"');\n        cleaned = cleaned.replace(/,\\s*'([^']*)'/g, ',\"$1\"');\n        \n        // 4. Fix Python-style booleans and None\n        cleaned = cleaned.replace(/:\\s*True\\b/g, ': true');\n        cleaned = cleaned.replace(/:\\s*False\\b/g, ': false');\n        cleaned = cleaned.replace(/:\\s*None\\b/g, ': null');\n        \n        // 5. Escape unescaped newlines in string values\n        cleaned = cleaned.replace(/\"([^\"]*)\\n([^\"]*)\"/g, (match, p1, p2) => {\n            return `\"${p1}\\\\n${p2}\"`;\n        });\n        \n        // 6. Fix common markdown-in-JSON issues (unescaped special chars)\n        // This handles cases where markdown content has unescaped quotes inside JSON strings\n        cleaned = cleaned.replace(/\"([^\"]*?)(?<!\\\\)\"([^:,}\\]]*?)\"/g, (match, p1, p2) => {\n            // If we find internal unescaped quotes, escape them\n            if (p2 && !p2.startsWith(':') && !p2.startsWith(',')) {\n                return `\"${p1}\\\\\"${p2}\"`;\n            }\n            return match;\n        });\n        \n        // 7. Remove control characters that break JSON\n        cleaned = cleaned.replace(/[\\x00-\\x1F\\x7F]/g, (char) => {\n            if (char === '\\n') return '\\\\n';\n            if (char === '\\r') return '\\\\r';\n            if (char === '\\t') return '\\\\t';\n            return '';\n        });\n        \n        // 8. Fix mismatched brackets (simple cases)\n        const openBraces = (cleaned.match(/{/g) || []).length;\n        const closeBraces = (cleaned.match(/}/g) || []).length;\n        if (openBraces > closeBraces) {\n            cleaned += '}'.repeat(openBraces - closeBraces);\n            console.log(`âš ï¸ Added ${openBraces - closeBraces} missing closing braces`);\n        }\n        \n        const openBrackets = (cleaned.match(/\\[/g) || []).length;\n        const closeBrackets = (cleaned.match(/]/g) || []).length;\n        if (openBrackets > closeBrackets) {\n            cleaned += ']'.repeat(openBrackets - closeBrackets);\n            console.log(`âš ï¸ Added ${openBrackets - closeBrackets} missing closing brackets`);\n        }\n        \n        console.log('ğŸ”§ JSON repair completed, attempting parse...');\n        \n        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        // Attempt JSON Parse with Multiple Fallbacks\n        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        \n        let parseSuccess = false;\n        let result = null;\n        \n        // Attempt 1: Direct parse\n        try {\n            result = JSON.parse(cleaned);\n            parseSuccess = true;\n            console.log('âœ“ JSON parsed successfully on first attempt');\n        } catch (e1) {\n            console.log(`âš ï¸ First parse attempt failed: ${e1.message}`);\n            \n            // Attempt 2: Try removing last few characters and re-closing\n            try {\n                let truncated = cleaned.substring(0, cleaned.length - 50);\n                // Find last complete property\n                const lastCompleteProperty = truncated.lastIndexOf('\",');\n                if (lastCompleteProperty > 0) {\n                    truncated = truncated.substring(0, lastCompleteProperty + 1) + '}';\n                    result = JSON.parse(truncated);\n                    parseSuccess = true;\n                    console.log('âœ“ JSON parsed after truncation repair');\n                }\n            } catch (e2) {\n                console.log(`âš ï¸ Truncation repair failed: ${e2.message}`);\n            }\n            \n            // Attempt 3: Extract just the markdown field if possible\n            if (!parseSuccess) {\n                try {\n                    const markdownMatch = cleaned.match(/\"(?:formatted_markdown|markdown)\"\\s*:\\s*\"((?:[^\"\\\\]|\\\\.)*)\"/);\n                    if (markdownMatch) {\n                        markdown = markdownMatch[1]\n                            .replace(/\\\\n/g, '\\n')\n                            .replace(/\\\\\"/g, '\"')\n                            .replace(/\\\\\\\\/g, '\\\\');\n                        structured = { extracted_via_regex: true };\n                        parseSuccess = true;\n                        console.log('âœ“ Extracted markdown via regex fallback');\n                    }\n                } catch (e3) {\n                    console.log(`âš ï¸ Regex extraction failed: ${e3.message}`);\n                }\n            }\n        }\n        \n        // Process successful parse\n        if (parseSuccess && result) {\n            markdown = result.formatted_markdown || result.markdown || result.content || '';\n            structured = result.structured_data || result.structured || result.metadata || result;\n            \n            // If markdown is still empty but we have pre-JSON markdown, use that\n            if (!markdown && preJsonMarkdown) {\n                markdown = preJsonMarkdown;\n            }\n            \n            console.log('âœ“ JSON processing completed successfully');\n        } else if (!markdown) {\n            // Complete fallback: treat entire raw text as markdown\n            console.log('âš ï¸ All JSON parsing attempts failed, using raw content as markdown');\n            markdown = rawText\n                .replace(/^```json\\s*/gi, '')\n                .replace(/^```\\s*/gi, '')\n                .replace(/```\\s*$/g, '')\n                .trim();\n            structured = { fallback_mode: true, original_error: 'JSON parsing failed' };\n        }\n    } else {\n        // No JSON structure found, treat as markdown\n        console.log('âš ï¸ No JSON structure detected, treating entire content as markdown');\n        markdown = rawText.trim();\n        structured = {};\n    }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// STEP 4: FINAL OUTPUT FORMATTING\n// Ensure compatibility with Part 2 automation\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Clean up markdown\nif (markdown) {\n    // Remove any remaining code fences\n    markdown = markdown\n        .replace(/^```(?:json|markdown)?\\s*/gim, '')\n        .replace(/```\\s*$/gm, '')\n        .trim();\n    \n    // Ensure proper line endings\n    markdown = markdown.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n');\n}\n\n// Validate we have content\nif (!markdown || markdown.length < 20) {\n    console.log('âš ï¸ Warning: Markdown content is very short or empty');\n    console.log('Raw text sample:', rawText.substring(0, 500));\n    \n    // Last resort fallback\n    if (rawText.length > 50) {\n        markdown = rawText\n            .replace(/^```json\\s*/gi, '')\n            .replace(/```\\s*$/g, '')\n            .trim();\n        console.log('âš ï¸ Using raw text as final fallback');\n    }\n}\n\nconsole.log(`âœ… LinkedIn Draft Processor Complete`);\nconsole.log(`ğŸ“Š Markdown length: ${markdown.length} chars`);\nconsole.log(`ğŸ“Š Has structured data: ${Object.keys(structured).length > 0}`);\n\nreturn {\n    json: {\n        markdown: markdown,\n        structured: structured,\n        platform: 'linkedin'\n    }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5584,
                1280
            ],
            "id": "218b9159-d343-4505-88f1-f4474ffce0c4",
            "name": "Process & Format LinkedIn Draft"
        },
        {
            "parameters": {
                "resource": "folder",
                "name": "={{ $('Notion â€“ Get Ready Content').item.json.name }}-SocialDrafts-{{ $json.sessionId }}",
                "driveId": {
                    "__rl": true,
                    "mode": "list",
                    "value": "My Drive"
                },
                "folderId": {
                    "__rl": true,
                    "value": "1F25H1IcOyYzJa41LwbD-r31_Ogs6ASZd",
                    "mode": "list",
                    "cachedResultName": "N8N Build in public Drafts - LinkedIn & X",
                    "cachedResultUrl": "https://drive.google.com/drive/folders/1F25H1IcOyYzJa41LwbD-r31_Ogs6ASZd"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.googleDrive",
            "typeVersion": 3,
            "position": [
                3120,
                1568
            ],
            "id": "985595ce-bc57-4858-bb2f-26685ff5a68f",
            "name": "Create folder for title",
            "credentials": {
                "googleDriveOAuth2Api": {
                    "id": "1hcyFpBqSOMDRDna",
                    "name": "Google Drive Adude"
                }
            }
        },
        {
            "parameters": {
                "content": "Creating a separate folder in Drive to store all the assets & generated drafts",
                "height": 224,
                "width": 224
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                3056,
                1504
            ],
            "typeVersion": 1,
            "id": "e7ef23f8-03d0-4b79-b738-55e0c9621e21",
            "name": "Sticky Note3"
        },
        {
            "parameters": {
                "content": "### 1. **Content Extraction** From Notion Database (4 nodes)\n",
                "height": 224,
                "width": 1536,
                "color": 7
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                2176,
                1504
            ],
            "typeVersion": 1,
            "id": "dcdf089a-a203-4a43-91de-b28f07ddc8f4",
            "name": "Sticky Note2"
        },
        {
            "parameters": {
                "content": "### 2. Notion Content Analysis & Processing (2 nodes)\n   - Content Extraction & processing - Code: Process & structure content\n   - Context Processing - Code: Personal context builder (user profile + summary)\n### 3. **Research Integration** (1 node)\n   - Perplexity API: Automated keyword research, hashtags, optimal posting times\n### 4. **Context Merging** (1 node)\n   - Code: Merge personal profile + source content + research into master context\n",
                "height": 240,
                "width": 1536,
                "color": 3
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                3408,
                1488
            ],
            "typeVersion": 1,
            "id": "203629f9-0e1e-4d86-af50-56cc853da194",
            "name": "Sticky Note4"
        },
        {
            "parameters": {
                "content": "## Updating Content to Notion \n",
                "height": 240,
                "width": 448,
                "color": 6
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                6192,
                1392
            ],
            "typeVersion": 1,
            "id": "3a503e9f-4e77-4328-9db1-8c1269043179",
            "name": "Sticky Note6"
        },
        {
            "parameters": {
                "messages": {
                    "message": [
                        {
                            "content": "=<role>\nYou are a social media research strategist specializing in Build-in-Public content for technical founders. Your expertise spans Twitter/X, LinkedIn, and technical blogging across diverse technology topics (Next.js, React, n8n automation, AI/ML, web performance, no-code/low-code, etc.).\n</role>\n\n<context>\n<profile>\n- primary_focus: {{ $json.personalContext.primary_focus }}\n- target_roles: {{$json.personalContext.targetRoles}}\n</profile>\n\n<topic>\n<name>{{$json.sourceContent.name}}</name>\n<categories>{{$json.sourceContent.categories}}</categories>\n<summary>{{$json.contentSummary.summary}}</summary>\n<audience>Technical founders, hiring managers, tech leads, developers</audience>\n<date>{{ $now }}</date>\n</topic>\n</context>\n\n<task>\nProvide comprehensive research and strategic recommendations for maximizing reach and engagement across Twitter, LinkedIn, and technical blogs for this SPECIFIC content topic.\n</task>\n\n<instructions>\n1. **Gap Analysis & Contrarian Angles (CRITICAL)**\n   - Don't just find trending topics. Find the *unanswered questions* in this niche.\n   - Identify \"Contrarian Angles\": What is the common advice in this niche that is actually wrong, inefficient, or outdated? (This drives high engagement).\n\n2. **Platform-Specific Strategy**\n   - **Twitter:** Find 3 recent \"viral\" tweets (100+ likes) on this specific topic. Analyze their *structure* (e.g., \"They started with a metric,\" \"They used a list\").\n   - **LinkedIn:** Identify the \"Business Problem\" this tech solves. (e.g., instead of just \"Next.js routing,\" focus on \"reducing page load time for better SEO/revenue\").\n   - **Blog:** Find 3 long-tail keywords with high intent (e.g., \"how to fix n8n webhook timeout\") rather than generic ones (e.g., \"n8n tutorial\").\n\n3. **Competitive Intelligence**\n   - Identify 2-3 creators in the AgenticAI/No-Code/Dev space covering this. What specific technical details do they usually skip? (Aman will cover these to show authority).\n  - Note their successful content patterns\n  - Highlight differentiation opportunities\n\n4. **Timing Data**\n   - Provide optimal posting times specifically for **Asia/Kolkata (IST)** targeting a global tech audience (US/EU overlap times).\n</instructions>\n\n<outputformat>\nReturn ONLY valid JSON with this EXACT structure (no markdown fences):\n\n{\n  \"twitter\": {\n    \"hashtags\": [\"#BuildInPublic\", \"#ReactDev\", \"#WebPerf\"],\n    \"hashtags_explanation\": \"Why these specific hashtags work now\",\n    \"optimal_posting_times_ist\": [\"09:00 AM\", \"01:00 PM\", \"06:00 PM\"],\n    \"timing_rationale\": \"Why these times work for technical audience\",\n    \"current_trends\": \"What's trending in this niche\",\n    \"successful_hook_patterns\": [\"Hook type 1\", \"Hook type 2\"],\n    \"content_angles\": [\"Angle 1\", \"Angle 2\"],\n    \"avoid\": [\"Common mistake 1\", \"Common mistake 2\"]\n  },\n  \"linkedin\": {\n    \"hashtags\": [\"#TechLeadership\", \"#WebDevelopment\"],\n    \"hashtags_explanation\": \"Strategic reasoning\",\n    \"optimal_posting_times_ist\": [\"08:00 AM\", \"12:00 PM\", \"05:00 PM\"],\n    \"timing_rationale\": \"Professional audience patterns\",\n    \"current_trends\": \"Trending topics\",\n    \"successful_formats\": [\"Format 1\", \"Format 2\"],\n    \"tone_recommendations\": \"Professional yet authentic guidance\",\n    \"avoid\": [\"Professional pitfalls\"]\n  },\n  \"blog\": {\n    \"seo_keywords_primary\": [\n      {\"keyword\": \"next.js performance\", \"volume\": \"high\", \"difficulty\": \"medium\"}\n    ],\n    \"seo_keywords_longtail\": [\n      {\"keyword\": \"optimizing next.js bundle size 2024\", \"volume\": \"low\", \"difficulty\": \"low\"}\n    ],\n    \"related_topics\": [\"Topic to establish topical authority\"],\n    \"internal_linking_opportunities\": [\"Suggested related post topics\"]\n  },\n  \"competitor_insights\": {\n    \"creator\": \"Name\",\n    \"what_works\": \"Pattern they use\"\n  },\n  \"general_strategy\": {\n    \"unique_angle\": \"How to differentiate in this content\",\n    \"psychological_hooks\": \"Hook type that works for this topic\",\n    \"timing_considerations\": \"When this topic resonates most\"\n  }\n}\n</outputformat>\n\n<constraints>\n- Focus on CURRENT (last 30 days) trends, not generic advice\n- Hashtags must be SPECIFIC to the content topic, not generic \"#coding\"\n- Research REAL data on what's working, don't invent trends\n- Provide actionable, specific recommendations\n- No corporate jargon or generic marketing speak\n</constraints>\n\nThink step-by-step before responding.\n"
                        }
                    ]
                },
                "options": {
                    "maxTokens": 1500,
                    "temperature": 0.3
                },
                "requestOptions": {}
            },
            "id": "5ccc3ebc-c0da-4ddd-8ab2-16ec7adc23f4",
            "name": "Perplexity â€“ Research Hashtags & Timing",
            "type": "n8n-nodes-base.perplexity",
            "typeVersion": 1,
            "position": [
                4240,
                1568
            ],
            "credentials": {
                "perplexityApi": {
                    "id": "Ss20gojfOfH1gtj7",
                    "name": "Perplexity Anki"
                }
            }
        },
        {
            "parameters": {
                "operation": "createFromText",
                "content": "={{ $json.markdown }}",
                "name": "=LinkedIndraft-{{ $('Process AI Strategy & MERGE CONTEXT').item.json.sourceContent.title }}-{{ $('Code â€“ Select Content & Profile').all()[0].json.sessionId }}.md",
                "driveId": {
                    "__rl": true,
                    "mode": "list",
                    "value": "My Drive"
                },
                "folderId": {
                    "__rl": true,
                    "value": "=https://drive.google.com/drive/u/2/folders/{{ $('Create folder for title').all()[0].json.id }}",
                    "mode": "url"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.googleDrive",
            "typeVersion": 3,
            "position": [
                5808,
                1280
            ],
            "id": "ad7eb012-1045-4f36-85d1-247d616614ab",
            "name": "Create LinkedIn Draft",
            "credentials": {
                "googleDriveOAuth2Api": {
                    "id": "1hcyFpBqSOMDRDna",
                    "name": "Google Drive Adude"
                }
            }
        },
        {
            "parameters": {
                "operation": "createFromText",
                "content": "={{ $json.markdown }}",
                "name": "=Twitterdraft-{{ $('Process AI Strategy & MERGE CONTEXT').item.json.sourceContent.title }}-{{ $('Code â€“ Select Content & Profile').all()[0].json.sessionId }}.md",
                "driveId": {
                    "__rl": true,
                    "value": "My Drive",
                    "mode": "list",
                    "cachedResultName": "My Drive",
                    "cachedResultUrl": "https://drive.google.com/drive/my-drive"
                },
                "folderId": {
                    "__rl": true,
                    "value": "=https://drive.google.com/drive/u/2/folders/{{ $('Create folder for title').all()[0].json.id }}",
                    "mode": "url"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.googleDrive",
            "typeVersion": 3,
            "position": [
                5808,
                896
            ],
            "id": "41d8da98-80fc-46d9-b552-b2f171c58d3b",
            "name": "Create Twitter Draft",
            "credentials": {
                "googleDriveOAuth2Api": {
                    "id": "1hcyFpBqSOMDRDna",
                    "name": "Google Drive Adude"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PROCESS & FORMAT BLOG DRAFT (ROBUST PARSER)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inputJson = $input.first().json;\nlet rawText = '';\n\n// ----------------------------------------------------------------------------\n// 1. UNIVERSAL INPUT EXTRACTION\n// ----------------------------------------------------------------------------\ntry {\n  if (inputJson.choices?.[0]?.message?.content) {\n    rawText = inputJson.choices[0].message.content; // OpenAI / GitHub\n  } else if (inputJson.output?.[0]?.content?.[0]?.text) {\n    rawText = inputJson.output[0].content[0].text; // n8n LangChain\n  } else if (typeof inputJson.response === 'string') {\n    rawText = inputJson.response; // OpenRouter/Generic\n  } else if (typeof inputJson.output === 'string') {\n    rawText = inputJson.output; // OpenRouter/Generic\n  } else if (inputJson.content?.parts?.[0]?.text) {\n    rawText = inputJson.content.parts[0].text; // Gemini\n  } else if (inputJson.message?.content) {\n    rawText = inputJson.message.content; // Direct message\n  } else if (typeof inputJson === 'string') {\n    rawText = inputJson; // Raw string\n  } else {\n    // Last ditch: try to find any string property that looks like JSON or Markdown\n    const potentialKey = Object.keys(inputJson).find(k => typeof inputJson[k] === 'string' && inputJson[k].length > 50);\n    if (potentialKey) {\n      rawText = inputJson[potentialKey];\n    } else {\n      throw new Error('Could not extract text from input');\n    }\n  }\n} catch (err) {\n  throw new Error(`Input extraction failed: ${err.message}`);\n}\n\n// ----------------------------------------------------------------------------\n// 2. CLEANUP & PARSING\n// ----------------------------------------------------------------------------\n\n// Remove Markdown Code Fences (```json ... ```)\nlet cleaned = rawText\n  .replace(/^```json\\s*/i, '')\n  .replace(/^```markdown\\s*/i, '')\n  .replace(/^```\\s*/i, '')\n  .replace(/```\\s*$/g, '')\n  .trim();\n\nlet fullMarkdown = '';\nlet structuredData = {};\nlet parseSuccess = false;\n\n// Attempt 1: Standard JSON Parse\ntry {\n  // Simple fixes for common issues before parsing\n  // Fix 1: Remove trailing commas before closing braces\n  let preProcessed = cleaned.replace(/,\\s*}/g, '}').replace(/,\\s*]/g, ']');\n  \n  const result = JSON.parse(preProcessed);\n  fullMarkdown = result.formatted_markdown || result.markdown || result.content || '';\n  structuredData = result.structured_data || result;\n  parseSuccess = true;\n  console.log('âœ… Standard JSON parse succeeded');\n} catch (e) {\n  console.log('âš ï¸ Standard JSON parse failed. Attempting recovery...');\n}\n\n// Attempt 2: Emergency Regex Extraction (If JSON is broken/truncated)\nif (!parseSuccess) {\n  try {\n    // Look for content inside \"formatted_markdown\": \"...\" handling escaped quotes\n    // This regex looks for the key, then grabs everything until it hits a quote that isn't escaped, followed by a comma or closing brace\n    const match = cleaned.match(/\"formatted_markdown\"\\s*:\\s*\"([\\s\\S]*?)(?=(?<!\\\\)\"\\s*(,|}|]|$))/);\n    \n    if (match && match[1]) {\n      // We found the text! Now we must unescape it manually because it was inside a JSON string\n      fullMarkdown = match[1]\n        .replace(/\\\\\"/g, '\"')  // Unescape quotes\n        .replace(/\\\\n/g, '\\n') // Unescape newlines\n        .replace(/\\\\\\\\/g, '\\\\') // Unescape backslashes\n        .replace(/\\\\t/g, '\\t');\n        \n      console.log('âœ… Recovered markdown via Regex extraction');\n      parseSuccess = true;\n    } else {\n      console.log('âš ï¸ Regex extraction failed.');\n    }\n  } catch (err) {\n    console.log('âš ï¸ Regex recovery error:', err.message);\n  }\n}\n\n// Attempt 3: Fallback to treating the whole output as the content\nif (!parseSuccess) {\n  // If it starts with a JSON brace but failed parsing, strip the braces\n  if (cleaned.trim().startsWith('{')) {\n    // Heuristic: Just take the raw text, assuming the LLM failed the JSON format completely\n    // We try to strip the specific JSON preamble if visible\n    fullMarkdown = cleaned\n      .replace(/^{\\s*\"formatted_markdown\"\\s*:\\s*\"/, '') // Remove opening JSON key\n      .replace(/\"\\s*}\\s*$/, '') // Remove closing JSON brace\n      .replace(/\\\\n/g, '\\n'); // Attempt to fix newlines\n      \n    // If the result looks like garbage (still JSON syntax), just use original rawText\n    if (fullMarkdown.includes('\"structured_data\":')) {\n       fullMarkdown = rawText; // Give up and return raw\n    }\n  } else {\n    // It wasn't JSON to begin with, just Markdown\n    fullMarkdown = rawText;\n  }\n  console.log('âš ï¸ Used fallback raw text mode');\n}\n\n// ----------------------------------------------------------------------------\n// 3. POST-PROCESSING & OUTPUT\n// ----------------------------------------------------------------------------\n\n// Ensure we have something\nif (!fullMarkdown || fullMarkdown.length < 50) {\n  fullMarkdown = \"# Draft Generation Failed\\n\\nCould not recover content from AI response. Check input logs.\";\n}\n\n// SEO Data Extraction (Best Effort)\nconst seoData = {\n  title: structuredData.title || structuredData.seo_title || (fullMarkdown.match(/^#\\s+(.+)$/m) || [])[1] || 'Untitled Blog Post',\n  slug: structuredData.slug || '',\n  metaDescription: structuredData.meta_description || structuredData.description || '',\n  keywords: structuredData.seo_keywords || [],\n  tags: structuredData.tags || []\n};\n\n// Word count\nconst wordCount = fullMarkdown.split(/\\s+/).filter(w => w.length > 0).length;\n\nconsole.log(`âœ… Final processing complete. Length: ${wordCount} words.`);\n\nreturn {\n  json: {\n    markdown: fullMarkdown,\n    structured: structuredData,\n    seo: seoData,\n    platform: 'blog',\n    processing_method: parseSuccess ? 'parsed' : 'fallback'\n  }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5584,
                1664
            ],
            "id": "11080ba3-1932-47f5-8883-164eb7b64f77",
            "name": "Process & Format Blog Draft"
        },
        {
            "parameters": {
                "operation": "createFromText",
                "content": "={{ $json.markdown }}",
                "name": "=Blogdraft-{{ $('Process AI Strategy & MERGE CONTEXT').item.json.sourceContent.title }}-{{ $('Code â€“ Select Content & Profile').all()[0].json.sessionId }}.md",
                "driveId": {
                    "__rl": true,
                    "mode": "list",
                    "value": "My Drive"
                },
                "folderId": {
                    "__rl": true,
                    "value": "=https://drive.google.com/drive/u/2/folders/{{ $('Create folder for title').all()[0].json.id }}",
                    "mode": "url"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.googleDrive",
            "typeVersion": 3,
            "position": [
                5808,
                1664
            ],
            "id": "36b3838c-678b-4c77-88e3-e6d52696b802",
            "name": "Create Blog Draft",
            "credentials": {
                "googleDriveOAuth2Api": {
                    "id": "1hcyFpBqSOMDRDna",
                    "name": "Google Drive Adude"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PROCESS AI STRATEGY & MERGE CONTEXT (V4 - FINAL, ROBUST JSON PARSING)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('ğŸ“‹ V4: Starting robust JSON parsing...');\n// STEP 1: GET INPUTS FROM TWO DIFFERENT SOURCES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst geminiRawOutput = $input.first().json;\nconst originalContext = $('Code â€“ CONTEXT MERGER').first().json;\n\nif (!geminiRawOutput) {\n  throw new Error('âŒ No input from parent node (Gemini - AI CONTENT STRATEGIST).');\n}\nif (!originalContext) {\n  throw new Error(`âŒ Could not find data from referenced node: \"$('Code â€“ CONTEXT MERGER')\". Please verify the name.`);\n}\nconsole.log('âœ… Successfully loaded data from parent and context nodes.');\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// STEP 2: ROBUSTLY EXTRACT AND CLEAN JSON FROM GEMINI\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet strategy;\ntry {\n  let rawText = geminiRawOutput.content?.parts[0]?.text || '';\n  if (!rawText) {\n    throw new Error('Text content from Gemini is empty.');\n  }\n\n  // --- NEW ROBUST JSON EXTRACTION ---\n  // Find the first '{' and the last '}' to extract the JSON object,\n  // which is much more reliable than trying to strip markdown fences.\n  const firstBrace = rawText.indexOf('{');\n  const lastBrace = rawText.lastIndexOf('}');\n  \n  if (firstBrace === -1 || lastBrace === -1) {\n    throw new Error('Could not find a valid JSON object (missing \"{\" or \"}\").');\n  }\n\n  const jsonString = rawText.substring(firstBrace, lastBrace + 1);\n  // --- END OF NEW LOGIC ---\n\n  strategy = JSON.parse(jsonString);\n  console.log('âœ… Strategy parsed successfully using robust extraction.');\n\n} catch (error) {\n  console.error('âŒ Strategy parsing failed:', error.message);\n  throw new Error(`Failed to parse Gemini strategy: ${error.message}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// STEP 3: VALIDATE AND CREATE MASTER DATA OBJECT\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst requiredFields = ['strategy_summary', 'source_analysis', 'platform_strategies'];\nconst missingFields = requiredFields.filter(field => !strategy[field]);\n\nif (missingFields.length > 0) {\n  throw new Error(`Strategy object is missing required fields: ${missingFields.join(', ')}`);\n}\nconsole.log('âœ… Strategy structure validated.');\n\nconst masterData = {\n  personalContext: originalContext.personalContext,\n  sourceContent: originalContext.sourceContent,\n  research: originalContext.research,\n  workflowMetadata: originalContext.workflowMetadata,\n  strategy: strategy\n};\n\nconsole.log('âœ… Master data object created successfully.');\nconsole.log('ğŸ“¦ Final output contains keys:', Object.keys(masterData));\n\nreturn [{ json: masterData }];\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                4912,
                1568
            ],
            "id": "712531c3-77c6-4d30-9a0d-b9d8e39739bc",
            "name": "Process AI Strategy & MERGE CONTEXT"
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "e0a6bdb8-0521-4d53-a351-c2ec3f05310e",
                            "leftValue": "={{ $json.strategy.image_strategy.needs_images }}",
                            "rightValue": "",
                            "operator": {
                                "type": "boolean",
                                "operation": "true",
                                "singleValue": true
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                5360,
                2048
            ],
            "id": "e3dfc4ef-bfdf-44c2-bd49-4f41088b2d5a",
            "name": "Are Images Needed?",
            "onError": "continueRegularOutput"
        },
        {
            "parameters": {
                "content": "### Is Image Required & Processing\n",
                "height": 192,
                "width": 656
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                5304,
                2016
            ],
            "typeVersion": 1,
            "id": "1720b0fd-6da4-44eb-a36b-6bfff1e1eaa0",
            "name": "Sticky Note"
        },
        {
            "parameters": {
                "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CREATE IMAGE TASKLIST MARKDOWN\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('ğŸ“ Generating Image Tasklist...');\n\nconst strategy = $input.first().json.strategy.image_strategy;\nconst prompts = strategy.specific_prompts || [];\n\nif (prompts.length === 0) {\n  console.log('No specific prompts found. Returning empty tasklist.');\n  return [{ json: { image_tasklist_md: \"# ğŸ–¼ï¸ Image Tasklist\\n\\nNo specific images were recommended for this content.\", task_count: 0 } }];\n}\n\nlet markdown = `# ğŸ–¼ï¸ Image Tasklist for: ${$input.first().json.sourceContent.title}\\n\\n`;\nmarkdown += `**Reason:** ${strategy.rationale}\\n\\n---\\n\\n`;\n\nprompts.forEach((task, index) => {\n  markdown += `## Asset ${index + 1}: ${task.purpose}\\n\\n`;\n  markdown += `**â¡ï¸ Action Required:**\\n`;\n  \n  if (task.asset_type === 'real_asset') {\n    markdown += `*   **Type:** ğŸ“¸ Real Asset (Screenshot/Recording)\\n`;\n    markdown += `*   **Instructions:** ${task.description}\\n\\n`;\n    markdown += `**ğŸ’¡ Fallback (if real asset is unavailable):**\\n`;\n    markdown += `*   **Type:** ğŸ¤– Generative AI Prompt\\n`;\n    markdown += `*   **Prompt:** \\`${task.fallback_prompt}\\`\\n\\n`;\n  } else { // generative_asset\n    markdown += `*   **Type:** ğŸ¤– Generative AI Asset\\n`;\n    markdown += `*   **Prompt:** \\`${task.fallback_prompt || task.description}\\`\\n\\n`;\n  }\n\n  markdown += `**Placement:** ${task.position}\\n`;\n  markdown += `**Alt Text:** \"${task.alt_text}\"\\n\\n---\\n\\n`;\n});\n\nconsole.log(`âœ… Generated tasklist with ${prompts.length} items.`);\n\nreturn [{ json: { image_tasklist_md: markdown, task_count: prompts.length } }];\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5584,
                2048
            ],
            "id": "50ace94b-0b47-4694-97ff-39fbf39ae1cd",
            "name": "Process & Format Image Tasklist"
        },
        {
            "parameters": {
                "operation": "createFromText",
                "content": "={{ $json.image_tasklist_md }}",
                "name": "=Image Tasklist-{{ $('Process AI Strategy & MERGE CONTEXT').all()[0].json.sourceContent.title }}-{{ $('Code â€“ Select Content & Profile').all()[0].json.sessionId }}.md",
                "driveId": {
                    "__rl": true,
                    "mode": "list",
                    "value": "My Drive"
                },
                "folderId": {
                    "__rl": true,
                    "value": "=https://drive.google.com/drive/u/2/folders/{{ $('Create folder for title').all()[0].json.id }}",
                    "mode": "url"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.googleDrive",
            "typeVersion": 3,
            "position": [
                5808,
                2048
            ],
            "id": "6207774e-a5f5-497e-97ea-2e955036d59a",
            "name": "Create Image Tasklist",
            "credentials": {
                "googleDriveOAuth2Api": {
                    "id": "1hcyFpBqSOMDRDna",
                    "name": "Google Drive Adude"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "e6bbf5e8-5982-4daa-ac73-f54ca4f4cae5",
                            "leftValue": "={{ $('Notion â€“ Get Ready Content').first().json.property_post_to.includes('X') }}",
                            "rightValue": "",
                            "operator": {
                                "type": "boolean",
                                "operation": "true",
                                "singleValue": true
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                5136,
                992
            ],
            "id": "488ed2ae-b32b-426d-8e11-4fa454088a2b",
            "name": "IF - Twitter Selected?"
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "20913d76-b524-4cd5-9550-bb1e584cc9a5",
                            "leftValue": "={{ $('Notion â€“ Get Ready Content').first().json.property_post_to.includes('LinkedIn') }}",
                            "rightValue": "",
                            "operator": {
                                "type": "boolean",
                                "operation": "true",
                                "singleValue": true
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                5136,
                1376
            ],
            "id": "9a486617-0796-4c34-9529-d0fe4ef12ca4",
            "name": "IF - LinkedIn Selected?"
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "efebb240-a978-43aa-be26-00c040c5a359",
                            "leftValue": "={{ $('Notion â€“ Get Ready Content').first().json.property_post_to.includes('Blog') }}",
                            "rightValue": "",
                            "operator": {
                                "type": "boolean",
                                "operation": "true",
                                "singleValue": true
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                5136,
                1760
            ],
            "id": "5e61c98d-ce3f-4d7b-9217-53507cfbc723",
            "name": "IF - Blog Selected?"
        },
        {
            "parameters": {
                "jsCode": "// Return placeholder for skipped Twitter draft\nreturn [{\n  json: {\n    id: null,\n    platform: 'twitter',\n    skipped: true,\n    reason: 'Platform not selected in Notion'\n  }\n}];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5808,
                1088
            ],
            "id": "0dad04c9-2ddf-4dbe-848d-0ae42d8cbbeb",
            "name": "Code - No-Op Twitter Draft"
        },
        {
            "parameters": {
                "jsCode": "return [{\n  json: {\n    id: null,\n    platform: 'linkedin',\n    skipped: true,\n    reason: 'Platform not selected in Notion'\n  }\n}];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5808,
                1472
            ],
            "id": "f7171b93-573f-410d-9446-468463d6237f",
            "name": "Code - No-Op LinkedIn Draft"
        },
        {
            "parameters": {
                "jsCode": "return [{\n  json: {\n    id: null,\n    platform: 'blog',\n    skipped: true,\n    reason: 'Platform not selected in Notion'\n  }\n}];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5808,
                1856
            ],
            "id": "08ecfc47-1aed-481a-bd0c-1105583647d4",
            "name": "Code - No-Op Blog Draft"
        },
        {
            "parameters": {
                "resource": "databasePage",
                "operation": "update",
                "pageId": {
                    "__rl": true,
                    "value": "={{ $('Notion â€“ Get Ready Content').all()[0].json.id }}",
                    "mode": "id"
                },
                "propertiesUi": {
                    "propertyValues": [
                        {
                            "key": "Status|select",
                            "type": "select",
                            "selectValue": "Pending Approval"
                        },
                        {
                            "key": "TweetGenerated|checkbox",
                            "type": "checkbox",
                            "checkboxValue": "={{ !!$json.Twitter_id }}"
                        },
                        {
                            "key": "LinkedInPostGenerated|checkbox",
                            "type": "checkbox",
                            "checkboxValue": "={{ !!$json.LinkedIn_id }}"
                        },
                        {
                            "key": "BlogGenerated|checkbox",
                            "type": "checkbox",
                            "checkboxValue": "={{ !!$json.Blog_id }}"
                        },
                        {
                            "key": "TweetPreview|rich_text",
                            "textContent": "={{ $json.Twitter_id && $('Process & Format Twitter Draft').all().length > 0 ? $('Process & Format Twitter Draft').all()[0].json.markdown.substring(0, 1950) + '...' : 'Not generated - Platform not selected' }}"
                        },
                        {
                            "key": "LinkedinPreview|rich_text",
                            "textContent": "={{ $json.LinkedIn_id && $('Process & Format LinkedIn Draft').all().length > 0 ? $('Process & Format LinkedIn Draft').all()[0].json.markdown.substring(0, 1950) + '...' : 'Not generated - Platform not selected' }}"
                        },
                        {
                            "key": "BlogPreview|rich_text",
                            "textContent": "={{ $json.Blog_id && $('Process & Format Blog Draft').all().length > 0 ? $('Process & Format Blog Draft').all()[0].json.markdown.substring(0, 1950) + '...' : 'Not generated - Platform not selected' }}"
                        },
                        {
                            "key": "Twitter DraftURL|rich_text",
                            "richText": true,
                            "text": {
                                "text": [
                                    {
                                        "text": "={{ $json.Twitter_id ? `https://drive.google.com/file/d/${$json.Twitter_id}/view?usp=drive_link` : 'Not generated' }}",
                                        "isLink": "={{ !!$json.Twitter_id }}",
                                        "textLink": "={{ $json.Twitter_id ? `https://drive.google.com/file/d/${$json.Twitter_id}/view?usp=drive_link` : '' }}",
                                        "annotationUi": {}
                                    }
                                ]
                            }
                        },
                        {
                            "key": "LinkedIn DraftURL|rich_text",
                            "richText": true,
                            "text": {
                                "text": [
                                    {
                                        "text": "={{ $json.LinkedIn_id ? `https://drive.google.com/file/d/${$json.LinkedIn_id}/view?usp=drive_link` : 'Not generated' }}",
                                        "isLink": "={{ !!$json.LinkedIn_id }}",
                                        "textLink": "={{ $json.LinkedIn_id ? `https://drive.google.com/file/d/${$json.LinkedIn_id}/view?usp=drive_link` : '' }}",
                                        "annotationUi": {}
                                    }
                                ]
                            }
                        },
                        {
                            "key": "BlogDraftURL|rich_text",
                            "richText": true,
                            "text": {
                                "text": [
                                    {
                                        "text": "={{ $json.Blog_id ? `https://drive.google.com/file/d/${$json.Blog_id}/view?usp=drive_link` : 'Not generated' }}",
                                        "isLink": "={{ !!$json.Blog_id }}",
                                        "textLink": "={{ $json.Blog_id ? `https://drive.google.com/file/d/${$json.Blog_id}/view?usp=drive_link` : '' }}",
                                        "annotationUi": {}
                                    }
                                ]
                            }
                        },
                        {
                            "key": "Notes|rich_text",
                            "textContent": "=ğŸ“ CONTENT GENERATION COMPLETE\n\n{{ $json.Twitter_id ? 'âœ… Twitter: Generated' : 'â­ï¸ Twitter: Skipped' }}\n{{ $json.LinkedIn_id ? 'âœ… LinkedIn: Generated' : 'â­ï¸ LinkedIn: Skipped' }}\n{{ $json.Blog_id ? 'âœ… Blog: Generated' : 'â­ï¸ Blog: Skipped' }}\n\nâ³ STATUS: Pending Approval\nPlease review drafts and set Status to 'Approved' to begin posting.\n\nğŸ“„ Drive Folder: Available\nğŸ• Generated: {{ new Date().toLocaleString('en-IN', {timeZone: 'Asia/Kolkata'}) }} IST"
                        },
                        {
                            "key": "LinkedIn Best Time To Post|rich_text",
                            "textContent": "={{ $json.LinkedIn_id && $('Process AI Strategy & MERGE CONTEXT').all().length > 0 ? ($('Process AI Strategy & MERGE CONTEXT').all()[0].json.research?.optimalTimesIST?.linkedin_ist || 'N/A') : 'N/A - LinkedIn not selected' }}"
                        },
                        {
                            "key": "Twitter Best Time to post|rich_text",
                            "textContent": "={{ $json.Twitter_id && $('Process AI Strategy & MERGE CONTEXT').all().length > 0 ? (($('Process AI Strategy & MERGE CONTEXT').all()[0].json.research?.optimalTimesIST?.twitter_primary_ist || 'N/A') + '\\n&\\n' + ($('Process AI Strategy & MERGE CONTEXT').all()[0].json.research?.optimalTimesIST?.twitter_secondary_ist || 'N/A')) : 'N/A - Twitter not selected' }}"
                        },
                        {
                            "key": "ImageTaskList URL|rich_text",
                            "richText": true,
                            "text": {
                                "text": [
                                    {
                                        "text": "={{ $json.Image_Tasklist_id ? `https://drive.google.com/file/d/${$json.Image_Tasklist_id}/view?usp=drive_link` : 'No Assets required' }}",
                                        "isLink": "={{ !!$json.Image_Tasklist_id }}",
                                        "textLink": "={{ $json.Image_Tasklist_id ? `https://drive.google.com/file/d/${$json.Image_Tasklist_id}/view?usp=drive_link` : '' }}",
                                        "annotationUi": {}
                                    }
                                ]
                            }
                        },
                        {
                            "key": "hasImages / Assets|checkbox",
                            "checkboxValue": "={{ $('Process AI Strategy & MERGE CONTEXT').all().length > 0 ? ($('Process AI Strategy & MERGE CONTEXT').all()[0].json.strategy?.image_strategy?.needs_images || false) : false }}"
                        },
                        {
                            "key": "BlogSEOTitle|rich_text",
                            "textContent": "={{ $json.Blog_id && $('Process & Format Blog Draft').all().length > 0 ? ($('Process & Format Blog Draft').all()[0].json.structured?.seo?.title || '') : '' }}"
                        },
                        {
                            "key": "BlogSEODescription|rich_text",
                            "textContent": "={{ $json.Blog_id && $('Process & Format Blog Draft').all().length > 0 ? ($('Process & Format Blog Draft').all()[0].json.structured?.meta_description || $('Process & Format Blog Draft').all()[0].json.structured?.seo?.meta_description || '') : '' }}"
                        },
                        {
                            "key": "BlogSEOKeywords |rich_text",
                            "textContent": "={{ $json.Blog_id && $('Process & Format Blog Draft').all().length > 0 && $('Process & Format Blog Draft').all()[0].json.structured?.seo?.keywords ? $('Process & Format Blog Draft').all()[0].json.structured.seo.keywords.join(', ') : '' }}"
                        },
                        {
                            "key": "BlogSlug|rich_text",
                            "textContent": "={{ $json.Blog_id && $('Process & Format Blog Draft').all().length > 0 ? ($('Process & Format Blog Draft').all()[0].json.structured?.seo?.slug || '') : '' }}"
                        },
                        {
                            "key": "Drive Folder Link|url",
                            "urlValue": "=https://drive.google.com/drive/folders/{{ $('Create folder for title').all()[0].json.id }}?usp=drive_link"
                        }
                    ]
                },
                "options": {}
            },
            "id": "59a06920-2bcf-4e2c-971d-bc30c7cd57a1",
            "name": "Notion â€“ Create Drafts & Request Approval1",
            "type": "n8n-nodes-base.notion",
            "typeVersion": 2,
            "position": [
                6480,
                1472
            ],
            "credentials": {
                "notionApi": {
                    "id": "je8hKPK6RzYSk4JA",
                    "name": "Notion account 2"
                }
            }
        },
        {
            "parameters": {
                "model": "deepseek/deepseek-v3.2",
                "system_prompt": "=<system_instructions>\n<role>\nYou are a world-class Build-in-Public content strategist for Aman Suryavanshi, a Next.js developer and n8n automation specialist. Your primary job is to extract the REAL value from Aman's source content and craft a detailed, multi-platform content strategy. This includes both the textual content plan and a sophisticated visual asset plan.\n</role>\n\n<critical_instruction>\nâš ï¸ YOU MUST USE THE PROVIDED sourceContent.fullText AS THE SINGLE SOURCE OF TRUTH. Do not invent scenarios, projects, or examples. Aman shares his real implementation experienceâ€”your job is to extract and repurpose what he ACTUALLY did, not to write fiction. Every part of your strategy must be traceable back to the source content.\n</critical_instruction>\n\n<master_framework>\n<part_1_text_strategy>\n<mandatory_extraction_framework>\n\nPHASE 1: THE DETECTIVE SCAN (Data Extraction)\n1. **Scan for Hard Evidence:**\n   - Specific Projects: (e.g., \"Barkat Enterprise\", \"AV NewsStream\")\n   - Technical Implementations: (e.g., \"converted JPEG to WebP\", \"used n8n webhook\")\n   - Code Snippets/Logic: (Are there specific functions or configs mentioned?)\n   - Metrics: (e.g., \"Lighthouse 40->90\", \"Saved 5 hours/week\")\n   - The Struggle: What specific bug or blocker did Aman face?\n2. **Identify Content DNA:**\n   - Is it a **\"Vision/Thought\"**? (Raw ideas, roadmap, philosophy)\n   - Is it a **\"Case Study/Bug Fix\"**? (Engineering competence, specific solution)\n   - Is it a **\"Learning/Tutorial\"**? (Teaching a concept)\n\nPHASE 2: THE CAREER ENGINEER (Strategic Positioning)\n3. **The \"Money\" Angle (LinkedIn - For Clients/Jobs):**\n   - Translate the *Hard Evidence* into *Business Value*.\n   - *Example:* \"Fixed an API error\" â†’ \"Ensured 99.9% uptime for critical workflows.\"\n   - *Goal:* Prove Aman is a high-agency problem solver who saves/makes money.\n4. **The \"Alpha\" Angle (Twitter - For Dev Respect):**\n   - Extract the specific technical insight that 90% of juniors miss.\n   - *Example:* \"I used Next.js\" â†’ \"Why I chose Next.js ISR over SSR for this specific use case.\"\n   - *Goal:* Show technical depth and \"alpha\" (insider knowledge).\n5. **The \"Authority\" Angle (Blog - For SEO/Trust):**\n   - Identify the \"Hard Thing\" Aman figured out and structure it as the definitive guide.\n   - *Goal:* Create an asset that builds long-term domain authority.\n</mandatory_extraction_framework>\n\n<platform_adaptation_rules>\n**TWITTER (The Peer-to-Peer Cooler):**\n- **Goal:** Respect & Engagement.\n- **Style:** \"I found X. Here is exactly how it works.\" (No fluff).\n- **Structure:** 1 Tweet = 1 specific technical point.\n- **Hook Strategy:** Start with the *result* or the *pain*, never with \"Hello friends.\"\n\n**LINKEDIN (The Hiring Manager's Office):**\n- **Goal:** Inbound Leads (Jobs/Gigs).\n- **Style:** \"I solved a business problem using technology.\"\n- **Structure Selector (Pick ONE based on Content DNA):**\n   - *If Case Study:* The Hook (Result) â†’ The Struggle (Problem) â†’ The Solution (Logic) â†’ The CTA (Outcome).\n   - *If Vision:* The Observation (Trend) â†’ The Prediction (My take) â†’ The Plan (What I'm building) â†’ The Question.\n   - *If Tutorial:* The Goal â†’ The \"Old Way\" (Inefficient) â†’ The \"New Way\" (My solution) â†’ The Steps.\n\n**BLOG (The Technical Manual):**\n- **Goal:** SEO & Portfolio Depth.\n- **Style:** \"The Definitive Guide.\"\n- **Structure:** Context â†’ Implementation (Code) â†’ Edge Cases â†’ Final Result.\n</platform_adaptation_rules>\n\n<voice_requirements>\n**MANDATORY:**\n- Use the first-person (\"I\") voice\n- Reference specific projects from the source\n- Include real code and metrics\n\n**FORBIDDEN (The Anti-Slop List):**\n- Do NOT use: \"In today's digital landscape\", \"Delve\", \"Tapestry\", \"Beacon\", \"Game-changer\", \"Unlock\", \"Unleash\", \"Humbled to announce\", \"Thrilled to share\".\n- Do not use \"we\" unless the source specifies a team.\n- Avoid all fictional examples, generic advice, and corporate jargon.\n</voice_requirements>\n\n<content_length_adaptation>\n- **Deep Technical/Project:** Prioritize a **Multi-Tweet Thread** and a **Full Case Study** on LinkedIn.\n- **Quick Tip/Thought:** Prioritize a single **\"Hot Take\"** or **\"One-Pager\"** image post.\n</content_length_adaptation>\n</part_1_text_strategy>\n\n<part_2_image_strategy>\nCRITICAL: Determine IMAGE/ASSET NEEDS based on the source content. For each visual that would significantly enhance the text, create a detailed entry in the `specific_prompts` array.\n\n<image_rules>\n1. **Reality Check:** Only set `asset_type` to \"real_asset\" if the source content *explicitly* describes existing charts, logs, or UI screens. If not, default to \"generative_asset\" (diagrams/flowcharts).\n2. **Markers:** You MUST assign markers `<<IMAGE_1>>`, `<<IMAGE_2>>` sequentially.\n3. **Quantity:** Max 2-3 images. Quality over quantity.\n</image_rules>\n\n<for_each_visual_you_must_specify>\n1. **asset_type:** \"real_asset\" (screenshot) or \"generative_asset\" (AI diagram).\n2. **description:** Clear instruction for Aman.\n3. **fallback_prompt:** Detailed AI image generation prompt (Midjourney/DALL-E style).\n4. **position:** Placement in content.\n5. **alt_text:** SEO-friendly description.\n6. **marker:** âš ï¸ CRITICAL FORMAT: Use `<<IMAGE_1>>`, `<<IMAGE_2>>` (DOUBLE angle brackets).\n</for_each_visual_you_must_specify>\n\n<consistency_check>\nCRITICAL: If you insert <<IMAGE_1>> or <<IMAGE_2>> markers into the text content, you MUST:\n1. Set image_strategy.needs_images to true.\n2. Populate the image_strategy.specific_prompts array with the matching details.\nNEVER include markers in the text without defining them in the JSON array.\n</consistency_check>\n</part_2_image_strategy>\n</master_framework>\n\n<output_format>\nReturn ONLY valid JSON. The structure must contain all the fields from the previous prompts, with the `image_strategy` object fully populated according to the detailed rules in part_2_image_strategy.\n\n{\n  \"strategy_summary\": \"...\",\n  \"source_analysis\": \"...\",\n  \"core_insight\": \"...\",\n  \"story_arc\": \"...\",\n  \"platform_strategies\": {\n    \"twitter\": {\n      \"hashtags\": [],\n      \"content_breakdown\": [],\n      \"must_include\": []\n    },\n    \"linkedin\": {\n      \"hashtags\": [],\n      \"structure\": \"Selected Structure Name\",\n      \"must_include\": []\n    },\n    \"blog\": {\n      \"seo_keywords\": [],\n      \"structure\": [],\n      \"must_include\": []\n    }\n  },\n  \"authenticity_elements\": \"...\",\n  \"value_proposition\": \"...\",\n  \"image_strategy\": {\n    \"needs_images\": boolean,\n    \"rationale\": \"Why visuals are (or are not) needed for THIS specific content.\",\n    \"image_types\": [\"screenshot\", \"diagram\", etc.],\n    \"specific_prompts\": [\n      {\n        \"asset_type\": \"real_asset\" | \"generative_asset\",\n        \"description\": \"Specific instruction for Aman.\",\n        \"fallback_prompt\": \"Detailed AI image generation prompt.\",\n        \"position\": \"Where it goes in the content.\",\n        \"alt_text\": \"SEO-friendly alt text.\",\n        \"purpose\": \"Why this image is necessary.\",\n        \"marker\": \"<<IMAGE_1>>\" | \"<<IMAGE_2>>\" | \"<<IMAGE_3>>\"\n      }\n    ]\n  }\n}\n</output_format>\n\n<validation_checklist>\nBefore returning, you must verify:\n- The text strategy (Part 1) is 100% based on the source content.\n- The image strategy (Part 2) is detailed, actionable, and includes the `asset_type` and `fallback_prompt` for every requested image.\n- Image markers use DOUBLE angle brackets: `<<IMAGE_X>>`\n- The voice is consistently first-person (\"I\").\n- The final output is a single, valid JSON object with no extra text or markdown.\n</validation_checklist>\n</system_instructions>",
                "message": "=<context>\n<my_personal_professional_profile>\n{{ $json.personalContext }}\n</my_personal_professional_profile>\n\n<the_source_of_truth>\nâš ï¸ This is a HIGH-SIGNAL SUMMARY of the actual content. Use the technical details, metrics, and struggles extracted here to build the strategy.\n\nTOPIC: {{ $json.sourceContent.title }}\nCATEGORY: {{ $json.sourceContent.primaryCategory }}\nFULL SOURCE CONTENT (Use this absolute truth):\n{{ $json.sourceContent.fullText }}\n</the_source_of_truth>\n\n<complementary_seo_research_data>\nUse this to expand upon the core content and optimize for search.\n{{ $json.research }}\n</complementary_seo_research_data>\n</context>\n\n<task>\nAnalyze the High-Signal DNA provided above. Act as a \"Career Engineer\" to craft a comprehensive content strategy that transforms these raw insights into maximum **Authority** (Twitter), **Hireability** (LinkedIn), and **Trust** (Blog).\n\nYour specific goals are to:\n1. **Extract Core Value:** Identify the specific \"Money\" and \"Alpha\" angles that will attract high-quality connections, job offers, and freelance gigs.\n2. **Drive Engagement:** Design hooks and structures that maximize reach without sacrificing technical depth.\n3. **Plan Visuals:** Create a detailed plan for **visual assets** (screenshots, diagrams) that \"stop the scroll\" and prove your competence at a glance.\n\nâš ï¸ Constraint: The strategy must be strictly based on what was **ACTUALLY** done in the source content.\n</task>",
                "temperature": 0.3,
                "additionalFields": {
                    "frequency_penalty": 0.5,
                    "top_p": 1
                }
            },
            "type": "n8n-nodes-openrouter.openRouter",
            "typeVersion": 1,
            "position": [
                4688,
                1568
            ],
            "id": "83fb5daf-28aa-4ff8-8fec-04ddcbfb9895",
            "name": "OpenRouter - AI CONTENT STRATEGIST",
            "credentials": {
                "openRouterApi": {
                    "id": "Ykl5fjs1vWQ2yY7B",
                    "name": "OpenRouter temp2"
                }
            }
        },
        {
            "parameters": {
                "model": "deepseek/deepseek-v3.2",
                "system_prompt": "=<role>\nYou write as Aman Suryavanshi, a high-agency Next.js developer and n8n automation specialist. Your goal is NOT just to inform, but to build authority that attracts job offers and clients. Your voice is punchy, confident, and devoid of fluff. You are writing a viral-style Twitter thread based on the provided source content and strategy.\n</role>\n\n<critical_instruction>\nâš ï¸ YOU MUST USE THE PROVIDED SOURCE CONTENT AND PERSONAL CONTEXT. Your task is to transform the sourceContent.fullText into an engaging, authentic Twitter thread, guided by the strategy. Do NOT invent projects, examples, or results not found in the source material. Every tweet must be traceable to a specific point in Aman's actual work. Use the first-person (\"I\") voice.\n</critical_instruction>\n\n<rules>\n1. **Extract, Don't Invent:** Pull direct examples, project names (like \"Barkat Enterprise\"), and code snippets from the sourceContent.\n\n2. **Follow the Plan:** Adhere strictly to the `content_breakdown` and `must_include` fields within the `strategy.platform_strategies.twitter` object.\n\n3. **Voice:** Use \"I\" and \"my\". The personalContext provides the persona. Sound like a real developer sharing what you learned.\n\n4. **Structure (The Scroll-Stopper):**\n   - **Tweet 1 (The Hook):** MUST be a counter-intuitive statement, a specific hard number (metric), or a \"How to X without Y\" structure. NEVER start with \"Did you know\" or \"Here is a thread\".\n   - **Body Tweets:** One specific technical insight per tweet. Use whitespace for readability.\n   - **The \"Meat\":** Don't gatekeep. Give the code snippet or the specific config setting in the middle tweets.\n   - **Conclusion:** A short summary + a question to drive replies.\n\n5. **The \"Anti-Slop\" Filter (Strict):**\n  - ğŸš« BANNED WORDS: \"Unlock\", \"Unleash\", \"Game-changer\", \"Revolutionize\", \"In today's digital landscape\", \"Dive deep\", \"Buckle up\", \"Tapestry\", \"Beacon\", \"Elevate\".\n  - ğŸš« NO EMOJI VOMIT: Use max 1 emoji per tweet, purely for bullet points or emphasis.\n\n6. **âš ï¸ CHARACTER LIMITS (ABSOLUTE HARD STOP):**\n   - **MAXIMUM:** 260 characters per tweet. NO EXCEPTIONS.\n   - **Why:** To prevent automation failures, you must stay well below the 280 limit.\n   - **Calculation:** Count every letter, space, emoji (2 chars), punctuation, and hashtag.\n   - **If a tweet is too long:** YOU MUST rewrite it to be shorter. Do not just truncate; rephrase for brevity.\n   - **Constraint:** `content.length` MUST be <= 260.\n\n7. **Image Marker Insertion:**\n   - Check if `strategy.image_strategy.needs_images` is `true`\n   - If yes, review `strategy.image_strategy.specific_prompts` array\n   - For images where `position` mentions \"Twitter\" or \"thread\" or \"first tweet\":\n     - Insert the corresponding marker (`<<IMAGE_1>>`, `<<IMAGE_2>>`) from the `marker` field\n     - âš ï¸ CRITICAL FORMAT: Use DOUBLE angle brackets: `<<IMAGE_X>>`\n     - Place the marker on its OWN LINE immediately after the tweet content where the image should appear\n     - Add blank lines before and after the marker for readability\n   - Example:\n     ```\n     Tweet 1/5\n\n     I've been building with MCP and it's game-changing for AI development...\n\n     <<IMAGE_1>>\n\n     Here's what I learned ğŸ‘‡\n     ```\n\n8. **Graceful Marker Handling:**\n   - Image markers are OPTIONAL placeholders for Part 2 automation\n   - If images are not uploaded to Drive, Part 2 will automatically remove these markers\n   - Do NOT worry about whether images will be availableâ€”always insert markers when strategy recommends them\n   - The system is designed to handle missing images gracefullyâ€”posts will go out text-only if needed\n   - Never reference the markers in the actual tweet textâ€”they are invisible placeholders\n\n9. **Character Count Verification:**\n   - For EACH tweet, count the characters INCLUDING spaces and punctuation\n   - Store the exact count in the `char_count` field\n   - Verify: `content.length === char_count`\n   - If mismatch detected, flag in validation\n</rules>\n\n<output_format>\nReturn ONLY valid JSON that matches the structure requested in the previous prompts. The JSON should contain `formatted_markdown` for the full thread and a `structured_data` object with an array of individual tweets.\n\n{\n  \"formatted_markdown\": \"# Twitter Draft\\\\n\\\\nThread 1\\\\n\\\\n---\\\\n\\\\nTweet 1/4\\\\n\\\\nContent here\\\\n\\\\n<<IMAGE_1>>\\\\n\\\\n---\\\\n\\\\nTweet 2/4\\\\n\\\\nContent here...\",\n  \"structured_data\": {\n    \"threads\": [\n      {\n        \"thread_id\": 1,\n        \"theme\": \"Core insight from strategy\",\n        \"tweets\": [\n          {\n            \"position\": 1,\n            \"content\": \"Raw tweet textâ€”NO markdown, NO extra formatting\",\n            \"char_count\": 250,\n            \"image_marker\": \"<<IMAGE_1>>\",\n            \"type\": \"hook\"\n          },\n          {\n            \"position\": 2,\n            \"content\": \"Raw tweet text\",\n            \"char_count\": 240,\n            \"image_marker\": null,\n            \"type\": \"context\"\n          },\n          {\n            \"position\": 3,\n            \"content\": \"Raw tweet text\",\n            \"char_count\": 265,\n            \"image_marker\": \"<<IMAGE_2>>\",\n            \"type\": \"solution\"\n          },\n          {\n            \"position\": 4,\n            \"content\": \"Raw tweet text with hashtags\",\n            \"char_count\": 240,\n            \"image_marker\": null,\n            \"type\": \"lesson_cta\"\n          }\n        ]\n      }\n    ],\n    \"metadata\": {\n      \"total_threads\": 1,\n      \"total_tweets\": 4,\n      \"validation\": {\n        \"all_char_limits_met\": true,\n        \"all_counts_accurate\": true,\n        \"image_markers_correct_format\": true,\n        \"warnings\": []\n      }\n    }\n  }\n}\n</output_format>\n\n<validation_before_return>\nBefore returning JSON, verify:\nâ˜ All tweets are under character limits (270 for 1-3, 245 for final)\nâ˜ char_count matches content.length exactly for each tweet\nâ˜ Image markers use DOUBLE angle brackets: `<<IMAGE_X>>`\nâ˜ No AI clichÃ©s present (search for: \"excited\", \"dive deep\", \"game-changer\")\nâ˜ First-person \"I\" voice used throughout\nâ˜ Real project mentioned (not invented)\nâ˜ Specific metrics or examples included\nâ˜ Final tweet has 3-5 hashtags from research\nâ˜ JSON structure matches required schema exactly\nâ˜ No extra fields added beyond specification\n\nIf ANY validation fails:\n- Set `validation: false` in metadata\n- Include warning details in `metadata.validation.warnings`\n- Return the JSON anyway (don't fail silently)\n</validation_before_return>",
                "message": "=<context>\n<my_personal_profile>\n{{ $json.personalContext }}\n</my_personal_profile>\n\n<the_strategy_to_follow>\n{{ $json.strategy }}\n</the_strategy_to_follow>\n\n<the_source_of_truth>\nThe Notion Page Content is the most important input. Extract specific examples, code, and results from here.\n{{ $json.sourceContent.fullText }}\n</the_source_of_truth>\n</context>\n\n<task>\nGenerate a multi-tweet Twitter thread that follows the `twitter` section of the provided strategy. Extract specific, concrete tactics and examples from the sourceContent to build the thread.\n</task>",
                "temperature": 0.3,
                "additionalFields": {
                    "frequency_penalty": 0.5,
                    "top_p": 1
                }
            },
            "type": "n8n-nodes-openrouter.openRouter",
            "typeVersion": 1,
            "position": [
                5360,
                896
            ],
            "id": "ecb84d14-9434-4c96-81b3-d370dd8118ff",
            "name": "OpenRouter - Twitter Content Generation",
            "credentials": {
                "openRouterApi": {
                    "id": "Ykl5fjs1vWQ2yY7B",
                    "name": "OpenRouter temp2"
                }
            }
        },
        {
            "parameters": {
                "model": "deepseek/deepseek-v3.2",
                "system_prompt": "=<role>\nYou write as Aman Suryavanshi, a Next.js and Automation Developer. You are writing a professional LinkedIn post to showcase your expertise by sharing a case study or deep insight from your real project work. Your voice is thoughtful, authentic, and results-oriented.\n</role>\n\n<critical_instruction>\nâš ï¸ **GOAL: GET HIRED.** You must base this post on `sourceContent.fullText`, but frame it to demonstrate that Aman is a \"High-Agency\" developer. He doesn't just write code; he solves business problems. Even if the content is a simple bug fix, frame it as \"Ensuring system reliability.\" Use the first-person (\"I\") voice to assert competence.\n</critical_instruction>\n\n<rules>\n1. **The \"Result-First\" Framework:**\n   - **Line 1 (The Hook):** Start with the Result or the Insight. (e.g., \"How I cut API costs by 50%\" or \"Why I stopped using useEffect\").\n   - **Line 2 (The Context):** The \"Before\" state or the Pain point.\n   - **Body (The Engineering):** The specific Strategy/Logic used. Mention specific tools to prove depth.\n   - **Ending (The CTA):** A question or business insight for the reader.\n\n2. **Extract, Don't Invent:** Use the actual project names (\"Barkat Enterprise\"), technical details, and metrics (Lighthouse score 40 to 90+) found in the sourceContent.\n\n3. **Follow the Plan:** Adhere strictly to the structure and `must_include` directives in `strategy.platform_strategies.linkedin`.\n\n4. **Voice (High Agency):** Write in the **Active Voice** only.\n   - BAD: \"The database was optimized...\"\n   - GOOD: \"I optimized the database...\"\n   - BAD: \"Challenges were faced...\"\n   - GOOD: \"I fought with the API rate limits...\"\n   - Use short, punchy sentences. No academic fluff.\n\n5. **LinkedIn Formatting:** Use short paragraphs, whitespace for readability, and a concluding question to encourage engagement.\n\n6. **âš ï¸ CHARACTER LIMIT (CRITICAL - STRICTLY ENFORCED):**\n   - **Maximum:** 2800 characters (safe limit under LinkedIn API's 3000)\n   - **If post exceeds 2800 characters:**\n     - Trim to exactly 2750 characters and append \"\\\\n\\\\n[See full details in comments]\"\n     - Log a warning in the output\n     - NEVER silently exceed limits\n   - **Character count verification:**\n     - Count includes ALL text + line breaks + hashtags\n     - Store exact count in `char_count` field\n     - Verify: `content.length === char_count`\n\n7. **âš ï¸ LINE BREAK ENCODING (CRITICAL FOR FORMATTING):**\n   - **Paragraph breaks:** Use `\\\\n\\\\n` (double backslash-n)\n   - **Before numbered lists:** Use `\\\\n\\\\n\\\\n` (triple backslash-n) â† THIS IS CRITICAL\n   - **Hashtag separator:** Use `\\\\n\\\\n` (double backslash-n)\n   - **Example:**\n     ```\n     \"Here's what happened:\\\\n\\\\n\\\\n1. First insight...\\\\n2. Second insight...\\\\n\\\\nMore text here.\\\\n\\\\n#hashtag1 #hashtag2\"\n     ```\n\n8. **Image Marker Insertion:**\n   - Check if `strategy.image_strategy.needs_images` is `true`\n   - If yes, review `strategy.image_strategy.specific_prompts` array\n   - âš ï¸ LinkedIn API allows EXACTLY ONE image per post\n   - Place the marker (`<<IMAGE_1>>`) at the VERY END of the post (after hashtags if possible)\n   - âš ï¸ CRITICAL FORMAT: Use DOUBLE angle brackets: `<<IMAGE_1>>`\n   - Place on its own line with blank lines before/after\n   - Example:\n     ```\n     ...ending paragraph text.\n\n     #hashtag1 #hashtag2 #hashtag3\n\n     <<IMAGE_1>>\n     ```\n\n9. **Multiple Posts Logic:**\n   - If strategy recommends 2 LinkedIn posts, separate them with `---` (three hyphens)\n   - Each post must be self-contained and under 2800 characters\n   - Label as \"Part 1\" and \"Part 2\" if sequential\n\n10. **Character Count Verification:**\n    - For EACH post, count the characters INCLUDING all `\\\\n` sequences and hashtags\n    - Store the exact count in the `char_count` field\n    - Verify: `content.length === char_count`\n</rules>\n\n11. **Anti-Marketing Voice:**\n    - ğŸš« NO \"Thrilled to announce\".\n    - ğŸš« NO \"Humbled to share\".\n    - ğŸš« NO \"Let's connect!\".\n    - Start directly with the value or the story. Speak like a senior engineer, not a marketer.\n\n<output_format>\nReturn ONLY valid JSON that matches this structure:\n\n{\n  \"formatted_markdown\": \"# LinkedIn Draft\\\\n\\\\n---\\\\n\\\\nPost content here with proper \\\\\\\\n\\\\\\\\n\\\\\\\\n encoding...\\\\n\\\\n<<IMAGE_1>>\",\n  \"structured_data\": {\n    \"posts\": [\n      {\n        \"post_id\": 1,\n        \"content\": \"Full post text with proper \\\\\\\\n\\\\\\\\n and \\\\\\\\n\\\\\\\\n\\\\\\\\n encoding\",\n        \"char_count\": 2100,\n        \"image_marker\": \"<<IMAGE_1>>\",\n        \"hashtags\": [\"#hashtag1\", \"#hashtag2\", \"#hashtag3\"],\n        \"type\": \"case_study\"\n      }\n    ],\n    \"metadata\": {\n      \"total_posts\": 1,\n      \"total_chars\": 2100,\n      \"validation\": {\n        \"all_char_limits_met\": true,\n        \"line_break_encoding_correct\": true,\n        \"image_at_end_only\": true,\n        \"char_counts_accurate\": true,\n        \"warnings\": []\n      }\n    }\n  }\n}\n</output_format>\n\n<validation_before_return>\nBefore returning JSON, verify:\nâ˜ All posts are under 2800 characters\nâ˜ char_count matches content.length exactly for each post\nâ˜ Line breaks encoded correctly: `\\\\n\\\\n` for paragraphs, `\\\\n\\\\n\\\\n` before lists\nâ˜ Image marker uses DOUBLE angle brackets: `<<IMAGE_1>>`\nâ˜ Image marker at the end only (if present)\nâ˜ Hashtags at very end (3-5 count)\nâ˜ No AI clichÃ©s present\nâ˜ First-person \"I\" voice used\nâ˜ Real project mentioned (not invented)\nâ˜ Specific metrics or results included\nâ˜ JSON structure matches required schema exactly\n\nIf ANY validation fails:\n- Set `validation: false` in metadata\n- Include warning details in `metadata.validation.warnings`\n- Return the JSON anyway (don't fail silently)\n</validation_before_return>",
                "message": "=<context>\n<my_professional_profile>\n{{ $json.personalContext }}\n</my_professional_profile>\n\n<the_content_strategy_to_execute>\n{{ $json.strategy }}\n</the_content_strategy_to_execute>\n\n<the_source_of_truth>\nMy Actual Experienceâ€”code the core case study, challenges, and results from this text.\n{{ $json.sourceContent.fullText }}\n</the_source_of_truth>\n</context>\n\n<task>\nGenerate a professional LinkedIn post that follows the `linkedin` section of the provided strategy. Frame the sourceContent as a case study, sharing the problem you faced, the specific technical solution you implemented, and the measurable results you achieved.\n</task>",
                "temperature": 0.3,
                "additionalFields": {
                    "frequency_penalty": 0.5,
                    "top_p": 1
                }
            },
            "type": "n8n-nodes-openrouter.openRouter",
            "typeVersion": 1,
            "position": [
                5360,
                1280
            ],
            "id": "80819eb2-6ee6-4d2a-b1e8-f6da92eced1a",
            "name": "OpenRouter -  LinkedIn Content Generation",
            "credentials": {
                "openRouterApi": {
                    "id": "Ykl5fjs1vWQ2yY7B",
                    "name": "OpenRouter temp2"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://integrate.api.nvidia.com/v1/chat/completions",
                "authentication": "predefinedCredentialType",
                "nodeCredentialType": "httpBearerAuth",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {}
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"model\": \"nvidia/llama-3.3-nemotron-super-49b-v1\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": `<role>\nAct as Aman Suryavanshi, a Next.js and Automation Developer. You are writing a comprehensive, in-depth technical blog post. Your goal is to create a definitive, SEO-optimized guide based on your real-world experience.\n</role>\n\n<critical_instruction>\nThe \\`sourceContent.fullText\\` is the foundation. Your goal is to write a **\"Definitive Engineering Guide\"**. Do not just narrate what happened; explain the **Architectural Decisions**. Why this library? Why this pattern? Use \\`research\\` data, all while following the \\`strategy\\` & back up these decisions with industry best practices. This must serve as a portfolio piece that proves technical mastery. Use the \"I\" voice\n</critical_instruction>\n\n<rules>\n1.  **Source is King:** The structure, examples, and narrative must be built from the \\`sourceContent\\`. The project \"Barkat Enterprise\" and its metrics are the story.\n2. **The \"Stack Overflow\" Standard:**\n   - Every claim must be backed by a code snippet, a configuration example, or a specific logic flow.\n   - If detailing a bug fix, show the \"Before\" (Broken) code and the \"After\" (Fixed) code.\n   - Use \"Callout Blocks\" (> Quote style) for warnings, \"Pro-Tips,\" or \"Gotchas.\"\n3.  **Follow the Plan:** Strictly follow the \\`structure\\`, \\`must_include\\`, and \\`complementary_additions\\` outlined in \\`strategy.platform_strategies.blog\\`.\n4.  **Voice:** Maintain the first-person \"I\" narrative. This is a story about your personal project experience.\n5. **SEO & Discovery:**\n   - Naturally include the \\`research.blog.seo_keywords_primary\\` in the first 100 words and H2 headers.\n   - Include a \"Prerequisites\" section at the top (What does the reader need to know?).\n   - Include a \"Future Improvements\" section at the bottom (shows you are growth-minded).\n</rules>\n\n<visual_content_integration>\n**Image Marker Placement:**\n- Review strategy.imagestrategy.specificprompts for images marked for \"blog\" placement\n- Insert markers (<<IMAGE_1>>, <<IMAGE_2>>, <<IMAGE_3>>) in the markdown content at optimal positions\n- Place markers AFTER the relevant section heading and introductory paragraph\nâš ï¸ CRITICAL FORMAT: Use DOUBLE angle brackets for all image markers: <<IMAGE_1>>, <<IMAGE_2>>, <<IMAGE_3>>\n\n**Optimal Positioning Strategy:**\n- **First image**: After the introduction, before the first major section (sets visual context)\n- **Second image**: In the middle of the post, after explaining the core concept (reinforces understanding)\n- **Third image** (if exists): Near the end, before the conclusion or in a \"real-world example\" section (shows practical application)\n\n**Markdown Formatting Example:**\n\\`\\`\\`markdown\n## Section Heading\n\nIntroductory paragraph explaining the concept...\n\n<<IMAGE_1>>\n\nContinuing with more detailed explanation...\n\\`\\`\\`\n</visual_content_integration>\n\n<output_format>\nReturn ONLY valid JSON that matches the structure requested in the previous prompts. The JSON should include \\`formatted_markdown\\` and a detailed \\`structured_data\\` object with SEO fields, content sections, and image prompts.\n</output_format>`\n    },\n    {\n      \"role\": \"user\",\n      \"content\": `<context>\n### MY PERSONAL & PROFESSIONAL PROFILE\n${JSON.stringify($json.personalContext)}\n\n### THE BLUEPRINT FOR THE ARTICLE\n${JSON.stringify($json.strategy)}\n\n### THE CORE CONTENT (My Real-World Implementations)\nThis is the most critical input. The entire article must be built around the examples, code, and projects discussed here.\n${$json.sourceContent.fullText || \"\"}\n\n### COMPLEMENTARY SEO & RESEARCH DATA\nUse this to expand upon the core content and optimize for search.\n${JSON.stringify($json.research || {})}\n</context>\n\n<task>\nGenerate a full-length, SEO-optimized technical blog post that follows the \\`blog\\` section of the provided \\`strategy\\`. Use the \\`sourceContent\\` as the primary material and enrich it with explanations and complementary information as outlined in the strategy's \\`complementary_additions\\`.\n</task>`\n    }\n  ],\n  \"temperature\": 0.7\n}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                5360,
                1664
            ],
            "id": "17cc60c2-be09-476e-a6b9-dcc7ae384689",
            "name": "HTTP Request Nividia NIM --  Blog Content Generation",
            "credentials": {
                "httpBearerAuth": {
                    "id": "apbyWqfBZDKKduxM",
                    "name": "Sanity API Token"
                }
            }
        }
    ],
    "connections": {
        "When clicking 'Execute workflow'": {
            "main": [
                [
                    {
                        "node": "Notion â€“ Get Ready Content",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Notion â€“ Get Ready Content": {
            "main": [
                [
                    {
                        "node": "Filter â€“ Has Content",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter â€“ Has Content": {
            "main": [
                [
                    {
                        "node": "Code â€“ Select Content & Profile",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code â€“ Select Content & Profile": {
            "main": [
                [
                    {
                        "node": "Create folder for title",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Notion â€“ Update to Processing": {
            "main": [
                [
                    {
                        "node": "Notion â€“ Extract All Blocks",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Notion â€“ Extract All Blocks": {
            "main": [
                [
                    {
                        "node": "Code â€“ Extract & Process Content",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code â€“ Extract & Process Content": {
            "main": [
                [
                    {
                        "node": "Code â€“ Personal Context Builder",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge2": {
            "main": [
                [
                    {
                        "node": "ID Structuring",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ID Structuring": {
            "main": [
                [
                    {
                        "node": "Notion â€“ Create Drafts & Request Approval1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code â€“ Personal Context Builder": {
            "main": [
                [
                    {
                        "node": "Perplexity â€“ Research Hashtags & Timing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code â€“ CONTEXT MERGER": {
            "main": [
                [
                    {
                        "node": "OpenRouter - AI CONTENT STRATEGIST",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Process & Format Twitter Draft": {
            "main": [
                [
                    {
                        "node": "Create Twitter Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Process & Format LinkedIn Draft": {
            "main": [
                [
                    {
                        "node": "Create LinkedIn Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create folder for title": {
            "main": [
                [
                    {
                        "node": "Notion â€“ Update to Processing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Perplexity â€“ Research Hashtags & Timing": {
            "main": [
                [
                    {
                        "node": "Code â€“ CONTEXT MERGER",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create LinkedIn Draft": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "Create Twitter Draft": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Process & Format Blog Draft": {
            "main": [
                [
                    {
                        "node": "Create Blog Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Blog Draft": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 2
                    }
                ]
            ]
        },
        "Process AI Strategy & MERGE CONTEXT": {
            "main": [
                [
                    {
                        "node": "Are Images Needed?",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "IF - Twitter Selected?",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "IF - LinkedIn Selected?",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "IF - Blog Selected?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Are Images Needed?": {
            "main": [
                [
                    {
                        "node": "Process & Format Image Tasklist",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Process & Format Image Tasklist": {
            "main": [
                [
                    {
                        "node": "Create Image Tasklist",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Image Tasklist": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 3
                    }
                ]
            ]
        },
        "IF - Twitter Selected?": {
            "main": [
                [
                    {
                        "node": "OpenRouter - Twitter Content Generation",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Code - No-Op Twitter Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "IF - LinkedIn Selected?": {
            "main": [
                [
                    {
                        "node": "OpenRouter -  LinkedIn Content Generation",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Code - No-Op LinkedIn Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "IF - Blog Selected?": {
            "main": [
                [
                    {
                        "node": "HTTP Request Nividia NIM --  Blog Content Generation",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Code - No-Op Blog Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code - No-Op Twitter Draft": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code - No-Op LinkedIn Draft": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "Code - No-Op Blog Draft": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 2
                    }
                ]
            ]
        },
        "OpenRouter - AI CONTENT STRATEGIST": {
            "main": [
                [
                    {
                        "node": "Process AI Strategy & MERGE CONTEXT",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenRouter - Twitter Content Generation": {
            "main": [
                [
                    {
                        "node": "Process & Format Twitter Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenRouter -  LinkedIn Content Generation": {
            "main": [
                [
                    {
                        "node": "Process & Format LinkedIn Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP Request Nividia NIM --  Blog Content Generation": {
            "main": [
                [
                    {
                        "node": "Process & Format Blog Draft",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "instanceId": "2aff0c99a9b9ea9c976d68c5887d32445a6bdc6f59f99592eb5b4c4dbaf3d92e"
    }
}